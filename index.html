<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×˜×›× ×•-×œ×™×™×‘</title>
    <style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    direction: rtl;
    overflow: hidden;
}

.container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
    height: 100vh;
}

/* Login Screen */
.login-screen {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    height: 100vh;
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
}

.login-card {
    background: white;
    padding: 40px;
    border-radius: 20px;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
    text-align: center;
    min-width: 400px;
}

.logo {
    font-size: 2.5em;
    font-weight: bold;
    color: #667eea;
    margin-bottom: 20px;
}

.welcome-text {
    font-size: 1.2em;
    color: #666;
    margin-bottom: 30px;
}

.name-input {
    width: 100%;
    padding: 15px;
    font-size: 1.1em;
    border: 2px solid #ddd;
    border-radius: 10px;
    margin-bottom: 20px;
    text-align: center;
}

.name-input:focus {
    outline: none;
    border-color: #667eea;
}

.join-btn {
    width: 100%;
    padding: 15px;
    font-size: 1.2em;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    transition: transform 0.2s;
}

.join-btn:hover {
    transform: translateY(-2px);
}

.join-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

/* Main Screen */
.main-screen {
    display: none;
    height: 100vh;
    background: white;
    border-radius: 15px;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
}

.header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 15px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    height: 60px;
    flex-shrink: 0;
}

.session-info {
    display: flex;
    align-items: center;
    gap: 20px;
}

.user-info {
    display: flex;
    align-items: center;
    gap: 15px;
}

.score {
    background: rgba(255, 255, 255, 0.2);
    padding: 8px 15px;
    border-radius: 20px;
    font-weight: bold;
}

/* Content area - ×¤×©×•×˜ ×•×™×©×¨ */
.content-area {
    display: flex;
    height: calc(100vh - 60px);
}

.main-content {
    flex: 1;
    background: #f8f9fa;
    position: relative;
    overflow: hidden;
}


.chat-panel {
    width: 300px;
    background: white;
    border-right: 1px solid #ddd;
    display: flex;
    flex-direction: column;
    height: 100%;
}

.chat-header {
    background: #f8f9fa;
    padding: 12px 15px;
    border-bottom: 1px solid #ddd;
    font-weight: bold;
    height: 45px;
    flex-shrink: 0;
}

.chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
}

.chat-input-area {
    padding: 12px 15px;
    border-top: 1px solid #ddd;
    background: white;
    height: 55px;
    flex-shrink: 0;
}

.chat-input {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 20px;
    font-size: 14px;
    outline: none;
}

.chat-input:disabled {
    background: #f5f5f5;
    color: #999;
    cursor: not-allowed;
}

.chat-disabled-message {
    text-align: center;
    color: #999;
    font-size: 13px;
    padding: 10px;
    background: #f8f9fa;
    border-top: 1px solid #ddd;
    display: none;
}

/* Countdown Timer */
.countdown {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    height: 100%;
    text-align: center;
    font-size: 3em;
    color: #667eea;
    font-weight: bold;
}

.countdown-text {
    font-size: 1.2em;
    color: #666;
    margin-bottom: 30px;
}

/* Live Stream - ×¤×©×•×˜ */
.live-stream {
    width: 100%;
    height: 100%;
    background: #000;
    position: relative;
    overflow: hidden;
}

.live-stream video {
    width: 100%;
    height: 100%;
    object-fit: contain;
    background: #222;
}

/* ×”×¡×ª×¨ ×¤×§×“×™ ×•×™×“×™××• */
.live-stream video::-webkit-media-controls {
    display: none !important;
}

.live-stream video::-webkit-media-controls-panel {
    display: none !important;
}

.live-stream video::-webkit-media-controls-enclosure {
    display: none !important;
}

.live-stream video::-webkit-media-controls-overlay-enclosure {
    display: none !important;
}

/* Firefox */
.live-stream video::-moz-media-controls {
    display: none !important;
}

.live-indicator {
    position: absolute;
    top: 15px;
    left: 50%;
    transform: translateX(-50%);
    background: #ff4444;
    color: white;
    padding: 8px 15px;
    border-radius: 20px;
    font-size: 1em;
    font-weight: bold;
    animation: pulse 2s infinite;
    z-index: 10;
    box-shadow: 0 2px 10px rgba(0,0,0,0.3);
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}

/* Activity Frame */
.activity-frame {
    width: 100%;
    height: 100%;
    border: none;
}

/* Message styles */
.message {
    margin-bottom: 8px;
    padding: 6px 10px;
    border-radius: 8px;
    background: #f0f0f0;
    font-size: 13px;
    line-height: 1.3;
}

.message.system {
    background: #e3f2fd;
    color: #1976d2;
    font-style: italic;
}

.message-author {
    font-weight: bold;
    color: #667eea;
}

/* Video loading indicator */
.video-loading {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: white;
    font-size: 1.2em;
    display: none;
    z-index: 5;
}

/* Responsive */
@media (max-width: 768px) {
    .content-area {
        flex-direction: column;
    }
    
    .chat-panel {
        width: 100%;
        height: 200px;
        order: 2;
    }
    
    .main-content {
        flex: 1;
        order: 1;
    }
    
    .chat-messages {
        max-height: 120px;
    }
}
/* Picture-in-Picture ×©×œ ×”××“×¨×™×š */
.instructor-pip {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 250px;
    height: 180px;
    background: #000;
    border-radius: 15px;
    border: 3px solid #667eea;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    z-index: 1000;
    overflow: hidden;
    display: none;
    cursor: move;
}

.instructor-pip video {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 12px;
}

.instructor-pip .pip-header {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 5px 10px;
    font-size: 12px;
    font-weight: bold;
    text-align: center;
}

.instructor-pip .pip-controls {
    position: absolute;
    top: 5px;
    right: 5px;
    display: flex;
    gap: 5px;
}

.pip-btn {
    background: rgba(0,0,0,0.7);
    border: none;
    color: white;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    font-size: 10px;
    cursor: pointer;
}

/* ×›×©××—×–×™×§×™× ×’×¨×™×¨×” */
.instructor-pip.dragging {
    opacity: 0.8;
    transform: rotate(2deg);
}

/* ××¤×§×˜ hover */
.instructor-pip:hover {
    transform: scale(1.05);
    transition: transform 0.2s;
}
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="login-card">
            <div class="logo">ğŸ¯ ×˜×›× ×•-×œ×™×™×‘</div>
            <div class="welcome-text">×‘×¨×•×›×™× ×”×‘××™× ×œ×¡×©×Ÿ ×”×œ×™××•×“ ×”××™× ×˜×¨××§×˜×™×‘×™!</div>
            <input type="text" class="name-input" id="nameInput" placeholder="×”×›× ×¡ ××ª ×©××š ×›××Ÿ">
            <button class="join-btn" id="joinBtn" onclick="joinSession()">×”×¦×˜×¨×£ ×œ×¡×©×Ÿ</button>
            <div id="sessionStatus" style="margin-top: 20px; font-size: 0.9em; color: #666;"></div>
        </div>
    </div>

    <!-- Main Screen -->
    <div class="main-screen" id="mainScreen">
        <div class="header">
            <div class="session-info">
                <div class="logo">ğŸ¯ ×˜×›× ×•-×œ×™×™×‘</div>
                <div class="live-indicator" id="liveIndicator" style="display: none;">ğŸ”´ ×©×™×“×•×¨ ×—×™</div>
            </div>
            <div class="user-info">
                <span id="userName"></span>
                <div class="score" id="userScore">0 × ×§×•×“×•×ª</div>
            </div>
        </div>
        
        <div class="content-area">
            <div class="main-content" id="mainContent">
                <!-- Countdown Timer -->
                <div class="countdown" id="countdownTimer" style="display: none;">
                    <div class="countdown-text">×”×¡×©×Ÿ ××ª×—×™×œ ×‘×¢×•×“:</div>
                    <div id="countdown">05:00</div>
                </div>
                
                <!-- Live Stream -->
                <div class="live-stream" id="liveStream" style="display: none;">
<video id="studentVideo" autoplay playsinline 
       style="width: 100%; height: 100%; object-fit: contain; background: #222;">
</video>
                    <div class="video-loading" id="videoLoading">
                        ğŸ”„ ××ª×—×‘×¨ ×œ×©×™×“×•×¨...
                    </div>
                </div>
                
                <!-- Activity Frame -->
                <iframe class="activity-frame" id="activityFrame" style="display: none;"></iframe>
            </div>
            
<div class="chat-panel" id="chatPanel">
    <div class="chat-header">ğŸ’¬ ×¦'××˜</div>
    <div class="chat-messages" id="chatMessages"></div>
    <div class="chat-input-area" id="chatInputArea">
        <input type="text" class="chat-input" id="chatInput" placeholder="×›×ª×•×‘ ×”×•×“×¢×”..." onkeypress="handleChatEnter(event)">
    </div>
    <div class="chat-disabled-message" id="chatDisabledMessage">
        ×”×¦'××˜ ×›×‘×•×™ - ×œ× × ×™×ª×Ÿ ×œ×›×ª×•×‘ ×”×•×“×¢×•×ª
    </div>
</div>
        </div>
    </div>
<!-- Picture-in-Picture ×©×œ ×”××“×¨×™×š -->
<div class="instructor-pip" id="instructorPip">
    <div class="pip-header">×”××“×¨×™×š</div>
    <div class="pip-controls">
        <button class="pip-btn" onclick="togglePipSize()" title="×©× ×” ×’×•×“×œ">â›¶</button>
        <button class="pip-btn" onclick="closePip()" title="×¡×’×•×¨">Ã—</button>
    </div>
    <video id="instructorPipVideo" autoplay playsinline></video>
</div>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAfQaiAEs__1bQ1u6eO_W0kBjdo5yOCGmw",
            authDomain: "technolive-d5b92.firebaseapp.com",
            databaseURL: "https://technolive-d5b92-default-rtdb.firebaseio.com",
            projectId: "technolive-d5b92",
            storageBucket: "technolive-d5b92.firebasestorage.app",
            messagingSenderId: "999834099575",
            appId: "1:999834099575:web:58e8bb95b47f431159cb72"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Global Variables
        let sessionId = null;
        let participantId = null;
        let userName = null;
        let userScore = 0;
        let isChatEnabled = true; // âœ… ×”×•×¡×£ ××ª ×–×”

        // WebRTC Variables
        let peerConnection = null;
        let remoteStream = null;
        let offerProcessed = false; // × ×× ×¢ ××¢×™×‘×•×“ ×›×¤×•×œ

        // WebRTC Configuration
        const rtcConfig = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' },
                { urls: 'stun:stun2.l.google.com:19302' }
            ]
        };

        // Listen to WebRTC stream
// Listen to WebRTC stream
function listenToVideoStream() {
    console.log('ğŸ¥ ××ª×—×™×œ ×œ×”××–×™×Ÿ ×œ×©×™×“×•×¨ ×•×™×“×™××•...');
    
    let currentOfferTimestamp = 0; // ×œ×× ×•×¢ ×¢×™×‘×•×“ ×›×¤×•×œ
    
    // ×”××–×Ÿ ×œoffers ×¡×¤×¦×™×¤×™×™×
    database.ref(`sessions/${sessionId}/webrtc/offers/${participantId}`).on('value', async (snapshot) => {
        const data = snapshot.val();
        if (data && data.offer && data.timestamp > currentOfferTimestamp) {
            console.log('ğŸ“¨ ×”×ª×§×‘×œ offer ××™×©×™ ×—×“×©');
            currentOfferTimestamp = data.timestamp;
            offerProcessed = false; // ××¤×¡ ××ª ×”×“×’×œ
            await handleOffer(data.offer);
        }
    });
    
    // ×”××–×Ÿ ×œ-ICE candidates ×¡×¤×¦×™×¤×™×™×
    database.ref(`sessions/${sessionId}/webrtc/admin-candidates/${participantId}`).on('child_added', async (snapshot) => {
        const candidateData = snapshot.val();
        
        if (peerConnection && candidateData && peerConnection.remoteDescription) {
            try {
                // ×‘×“×•×§ ×©×”candidate ×ª×§×™×Ÿ
                if (candidateData.candidate && (candidateData.sdpMid !== null || candidateData.sdpMLineIndex !== null)) {
                    const iceCandidate = new RTCIceCandidate({
                        candidate: candidateData.candidate,
                        sdpMid: candidateData.sdpMid,
                        sdpMLineIndex: candidateData.sdpMLineIndex
                    });
                    
                    await peerConnection.addIceCandidate(iceCandidate);
                    console.log('âœ… ICE candidate × ×•×¡×£ ×‘×”×¦×œ×—×”');
                } else {
                    console.warn('âš ï¸ ICE candidate ×œ× ×ª×§×™×Ÿ:', candidateData);
                }
            } catch (error) {
                console.error('âŒ ×©×’×™××” ×‘×”×•×¡×¤×ª ICE candidate:', error);
            }
        } else {
            console.warn('âš ï¸ PeerConnection ×œ× ××•×›×Ÿ, ××—×›×”...');
        }
    });
}

async function handleOffer(offer) {
    try {
        console.log('ğŸ”„ ××¢×‘×“ WebRTC offer...');
        
        // ×•×•×“× ×©×œ× ××¢×‘×“×™× ××ª ××•×ª×• offer ×¤×¢××™×™×
        if (offerProcessed) {
            console.log('âš ï¸ Offer ×›×‘×¨ ××¢×•×‘×“, ××“×œ×’');
            return;
        }
        offerProcessed = true;
        
        // ×¡×’×•×¨ ×—×™×‘×•×¨ ×§×™×™× ×× ×™×©
        if (peerConnection) {
            peerConnection.close();
            peerConnection = null;
        }
        
        // Show loading indicator
        document.getElementById('videoLoading').style.display = 'block';
        
        // Initialize peer connection
        peerConnection = new RTCPeerConnection(rtcConfig);
        
        // Handle connection state changes
        peerConnection.onconnectionstatechange = () => {
            console.log('ğŸ”— ××¦×‘ ×—×™×‘×•×¨:', peerConnection.connectionState);
            if (peerConnection.connectionState === 'connected') {
                console.log('âœ… WebRTC ××—×•×‘×¨ ×‘×”×¦×œ×—×”!');
                document.getElementById('videoLoading').style.display = 'none';
            } else if (peerConnection.connectionState === 'failed') {
                console.log('âŒ WebRTC × ×›×©×œ, ×× ×¡×” ×©×•×‘...');
                setTimeout(() => {
                    offerProcessed = false;
                    handleOffer(offer);
                }, 3000);
            }
        };
        
        // Handle ICE candidates
        peerConnection.onicecandidate = (event) => {
            if (event.candidate) {
                console.log('ğŸ“¤ ×©×•×œ×— ICE candidate');
                
                const candidate = event.candidate;
                if (candidate.candidate && (candidate.sdpMid !== null || candidate.sdpMLineIndex !== null)) {
                    database.ref(`sessions/${sessionId}/webrtc/student-candidates`).push({
                        candidate: {
                            candidate: candidate.candidate,
                            sdpMid: candidate.sdpMid,
                            sdpMLineIndex: candidate.sdpMLineIndex
                        },
                        participantId: participantId,
                        timestamp: Date.now()
                    });
                } else {
                    console.warn('âš ï¸ ICE candidate ×œ× ×ª×§×™×Ÿ, ××“×œ×’...');
                }
            }
        };
        
        // Handle incoming stream
// ×ª×—×œ×™×£ ××ª ×”×—×œ×§ ×©×œ ontrack:
peerConnection.ontrack = async (event) => {
    console.log('ğŸ“º ×”×ª×§×‘×œ ×–×¨× ×•×™×“×™××• ××¨×•×—×§');
    
    if (event.streams && event.streams[0]) {
        remoteStream = event.streams[0];
        const videoElement = document.getElementById('studentVideo');
        
        // âœ¨ DEBUG ×—×“×©: ×‘×“×™×§×” ××” ×‘×××ª ×”×ª×§×‘×œ
        const videoTrack = remoteStream.getVideoTracks()[0];
        if (videoTrack) {
            const trackSettings = videoTrack.getSettings();
            console.log('ğŸ“¹ Received track settings:', trackSettings);
            
            // ×‘×“×•×§ stats ×©×œ ××” ×©××’×™×¢
            setTimeout(async () => {
                const stats = await peerConnection.getStats();
                stats.forEach(report => {
                    if (report.type === 'inbound-rtp' && report.mediaType === 'video') {
                        console.log('ğŸ“Š Inbound video stats:', {
                            width: report.frameWidth,
                            height: report.frameHeight,
                            bytesReceived: report.bytesReceived,
                            framesDecoded: report.framesDecoded
                        });
                    }
                });
            }, 3000);
        }
        
        // ×©××¨ ×”×§×•×“...
        videoElement.srcObject = remoteStream;
        // ×•×›×•'...
    }
};
        
        // Set remote description
        await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
        console.log('ğŸ“ Remote description × ×§×‘×¢');
        
        // Create answer
        const answer = await peerConnection.createAnswer();
        await peerConnection.setLocalDescription(answer);
        console.log('ğŸ“ Local description × ×§×‘×¢');
        
        // Send answer via Firebase
        await database.ref(`sessions/${sessionId}/webrtc/answers/${participantId}`).set({
            answer: answer,
            timestamp: Date.now()
        });
        
        console.log('ğŸ“¤ WebRTC answer × ×©×œ×—');
        
    } catch (error) {
        console.error('âŒ ×©×’×™××” ×‘×˜×™×¤×•×œ ×‘WebRTC offer:', error);
        document.getElementById('videoLoading').style.display = 'none';
        offerProcessed = false; // ××¤×¡ ××ª ×”×“×’×œ
        
        // Retry after delay
        setTimeout(() => {
            console.log('ğŸ”„ ×× ×¡×” ×©×•×‘...');
            handleOffer(offer);
        }, 5000);
    }
}

        // Get session ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        sessionId = urlParams.get('session');

        if (!sessionId) {
            document.getElementById('sessionStatus').innerHTML = 
                '<span style="color: red;">âŒ ×§×™×©×•×¨ ×œ× ×ª×§×™×Ÿ - ××™×Ÿ ××–×”×” ×¡×©×Ÿ</span>';
            document.getElementById('joinBtn').disabled = true;
        } else {
            document.getElementById('sessionStatus').innerHTML = 
                `<span style="color: green;">âœ… ××—×•×‘×¨ ×œ×¡×©×Ÿ: ${sessionId}</span>`;
            checkSessionStatus();
        }

        // Check if session exists
        function checkSessionStatus() {
            database.ref(`sessions/${sessionId}`).once('value', (snapshot) => {
                if (snapshot.exists()) {
                    const session = snapshot.val();
                    document.getElementById('sessionStatus').innerHTML += 
                        '<br><span style="color: blue;">×”×¡×©×Ÿ ×¤×¢×™×œ ×•××•×›×Ÿ!</span>';
                } else {
                    document.getElementById('sessionStatus').innerHTML = 
                        '<span style="color: orange;">â³ ×××ª×™× ×™× ×œ××“×¨×™×š ×œ×”×ª×—×™×œ ××ª ×”×¡×©×Ÿ...</span>';
                }
            });
        }

        // Join Session
        function joinSession() {
            const nameInput = document.getElementById('nameInput');
            const name = nameInput.value.trim();
            
            if (!name) {
                alert('× × ×œ×”×›× ×™×¡ ×©×');
                return;
            }
            
            if (!sessionId) {
                alert('×©×’×™××”: ××™×Ÿ ××–×”×” ×¡×©×Ÿ');
                return;
            }

            userName = name;
            participantId = generateParticipantId();
            
            // Add participant to Firebase
            database.ref(`sessions/${sessionId}/participants/${participantId}`).set({
                name: userName,
                score: 0,
                joinedAt: Date.now()
            }).then(() => {
                // Switch to main screen
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainScreen').style.display = 'block';
                document.getElementById('userName').textContent = userName;
                
                // Start listening to session updates
                listenToSessionUpdates();
                
                // Add system message
                addChatMessage('×”××¢×¨×›×ª', `${userName} ×”×¦×˜×¨×£ ×œ×¡×©×Ÿ`, 'system');
            }).catch((error) => {
                console.error('×©×’×™××” ×‘×”×¦×˜×¨×¤×•×ª:', error);
                alert('×©×’×™××” ×‘×”×¦×˜×¨×¤×•×ª ×œ×¡×©×Ÿ');
            });
        }

        // Generate unique participant ID
        function generateParticipantId() {
            return 'p_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }
// âœ… ×¤×•× ×§×¦×™×” ×—×“×©×” ×œ×¢×“×›×•×Ÿ ××¦×‘ ×”×¦'××˜
function updateChatStatus(enabled) {
    isChatEnabled = enabled;
    const chatInput = document.getElementById('chatInput');
    const chatInputArea = document.getElementById('chatInputArea');
    const chatDisabledMessage = document.getElementById('chatDisabledMessage');
    
    if (enabled) {
        chatInput.disabled = false;
        chatInput.placeholder = '×›×ª×•×‘ ×”×•×“×¢×”...';
        chatInputArea.style.display = 'block';
        chatDisabledMessage.style.display = 'none';
    } else {
        chatInput.disabled = true;
        chatInput.placeholder = '×”×¦\'××˜ ×›×‘×•×™';
        chatInputArea.style.display = 'none';
        chatDisabledMessage.style.display = 'block';
    }
}
        // Listen to session updates
        function listenToSessionUpdates() {
            const sessionRef = database.ref(`sessions/${sessionId}`);
            
            // Listen to current activity changes
            sessionRef.child('currentActivity').on('value', (snapshot) => {
                const activity = snapshot.val();
                updateMainContent(activity);
            });
            
              // âœ… ×”××–×Ÿ ×œ××¦×‘ ×”×¦'××˜ - ×”×•×¡×£ ××ª ×–×”
    sessionRef.child('chatEnabled').on('value', (snapshot) => {
        const chatEnabled = snapshot.val();
        updateChatStatus(chatEnabled !== false); // default true
    });
            // Listen to chat messages
            sessionRef.child('chat').on('child_added', (snapshot) => {
                const message = snapshot.val();
                displayChatMessage(message);
            });
            
            // Listen to score updates
            sessionRef.child(`participants/${participantId}/score`).on('value', (snapshot) => {
                const score = snapshot.val() || 0;
                userScore = score;
                document.getElementById('userScore').textContent = `${score} × ×§×•×“×•×ª`;
            });
            
            // Listen to video stream
            listenToVideoStream();
        }

        // Update main content based on activity
function updateMainContent(activity) {
    const countdownTimer = document.getElementById('countdownTimer');
    const liveStream = document.getElementById('liveStream');
    const activityFrame = document.getElementById('activityFrame');
    const liveIndicator = document.getElementById('liveIndicator');
    
    // Hide all content types
    countdownTimer.style.display = 'none';
    liveStream.style.display = 'none';
    activityFrame.style.display = 'none';
    liveIndicator.style.display = 'none';
    
    if (!activity) {
        countdownTimer.style.display = 'flex';
        hidePip(); // âœ… ×”×¡×ª×¨ PIP ×‘××¦×‘ countdown
        return;
    }
    
    switch (activity.type) {
        case 'countdown':
            countdownTimer.style.display = 'flex';
            if (activity.endTime) {
                startCountdown(activity.endTime);
            }
            hidePip(); // âœ… ×”×¡×ª×¨ PIP
            break;
            
        case 'live':
            liveStream.style.display = 'flex';
            liveIndicator.style.display = 'block';
            offerProcessed = false;
            hidePip(); // âœ… ×”×¡×ª×¨ PIP ×‘×©×™×“×•×¨ ×—×™ ××œ×
            break;
            
        case 'iframe':
            activityFrame.style.display = 'block';
            activityFrame.src = activity.url;
            
            // âœ… ×”×¦×’ PIP ×‘×¤×¢×™×œ×•×™×•×ª iframe
            setTimeout(() => {
                showInstructorPip();
            }, 1000); // ×—×›×” ×©×”iframe ×™×˜×¢×Ÿ
            break;
            
        default:
            hidePip();
            break;
    }
}

        // Start countdown timer
        function startCountdown(endTime) {
            const countdownElement = document.getElementById('countdown');
            
            const timer = setInterval(() => {
                const now = Date.now();
                const timeLeft = endTime - now;
                
                if (timeLeft <= 0) {
                    clearInterval(timer);
                    countdownElement.textContent = 'ğŸ‰ ×”×¡×©×Ÿ ××ª×—×™×œ!';
                    return;
                }
                
                const minutes = Math.floor(timeLeft / 60000);
                const seconds = Math.floor((timeLeft % 60000) / 1000);
                countdownElement.textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        // Handle chat enter
        function handleChatEnter(event) {
            if (event.key === 'Enter') {
                sendChatMessage();
            }
        }

        // Send chat message
function sendChatMessage() {
    if (!isChatEnabled) return; // âœ… ×‘×“×™×§×” × ×•×¡×¤×ª
    
    const chatInput = document.getElementById('chatInput');
    const message = chatInput.value.trim();
    
    if (!message) return;
    
    addChatMessage(userName, message);
    chatInput.value = '';
}

        // Add chat message to Firebase
        function addChatMessage(author, message, type = 'user') {
            database.ref(`sessions/${sessionId}/chat`).push({
                author: author,
                message: message,
                type: type,
                timestamp: Date.now()
            });
        }

        // Display chat message
        function displayChatMessage(messageData) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${messageData.type}`;
            
            if (messageData.type === 'system') {
                messageDiv.innerHTML = messageData.message;
            } else {
                messageDiv.innerHTML = 
                    `<span class="message-author">${messageData.author}:</span> ${messageData.message}`;
            }
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Handle page visibility change
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'hidden' && participantId) {
                // User left the session
                database.ref(`sessions/${sessionId}/participants/${participantId}`).update({
                    lastSeen: Date.now()
                });
            }
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (peerConnection) {
                peerConnection.close();
            }
            if (remoteStream) {
                remoteStream.getTracks().forEach(track => track.stop());
            }
        });

        // Add click-to-play fallback
document.addEventListener('DOMContentLoaded', () => {
    const videoElement = document.getElementById('studentVideo');
    videoElement.addEventListener('click', () => {
        if (videoElement.paused) {
            videoElement.play().catch(console.warn);
        }
    });
    
    // âœ… ××ª×—×œ ×’×¨×™×¨×” ×©×œ PIP
    initPipDragging();
});
        // âœ… ××©×ª× ×™× ×œ-PIP
let isPipVisible = false;
let pipSize = 'small'; // 'small' ××• 'large'
let isDragging = false;
let dragOffset = { x: 0, y: 0 };

// âœ… ×¤×•× ×§×¦×™×•×ª PIP
function showInstructorPip() {
    const pip = document.getElementById('instructorPip');
    const pipVideo = document.getElementById('instructorPipVideo');
    
    if (remoteStream && !isPipVisible) {
        pipVideo.srcObject = remoteStream.clone(); // ×©×›×¤×•×œ ×”×–×¨×
        pip.style.display = 'block';
        isPipVisible = true;
        
        // ×”×¤×¢×œ ××ª ×”×•×™×“×™××•
        pipVideo.muted = false; // ×¢× ×§×•×œ!
        pipVideo.play();
    }
}

function hidePip() {
    const pip = document.getElementById('instructorPip');
    const pipVideo = document.getElementById('instructorPipVideo');
    
    pip.style.display = 'none';
    pipVideo.srcObject = null;
    isPipVisible = false;
}

function closePip() {
    hidePip();
}

function togglePipSize() {
    const pip = document.getElementById('instructorPip');
    
    if (pipSize === 'small') {
        pip.style.width = '400px';
        pip.style.height = '300px';
        pipSize = 'large';
    } else {
        pip.style.width = '250px';
        pip.style.height = '180px';
        pipSize = 'small';
    }
}

// âœ… ×’×¨×™×¨×” ×©×œ ×”-PIP
function initPipDragging() {
    const pip = document.getElementById('instructorPip');
    
    pip.addEventListener('mousedown', (e) => {
        if (e.target.classList.contains('pip-btn')) return; // ×œ× ×œ×’×¨×•×¨ ×›×©×œ×•×—×¦×™× ×¢×œ ×›×¤×ª×•×¨
        
        isDragging = true;
        pip.classList.add('dragging');
        
        const rect = pip.getBoundingClientRect();
        dragOffset.x = e.clientX - rect.left;
        dragOffset.y = e.clientY - rect.top;
        
        e.preventDefault();
    });
    
    document.addEventListener('mousemove', (e) => {
        if (isDragging) {
            const newX = e.clientX - dragOffset.x;
            const newY = e.clientY - dragOffset.y;
            
            // ×”×’×‘×œ ×œ×’×‘×•×œ×•×ª ×”××¡×š
            const maxX = window.innerWidth - pip.offsetWidth;
            const maxY = window.innerHeight - pip.offsetHeight;
            
            pip.style.left = Math.max(0, Math.min(newX, maxX)) + 'px';
            pip.style.top = Math.max(0, Math.min(newY, maxY)) + 'px';
            pip.style.right = 'auto';
            pip.style.bottom = 'auto';
        }
    });
    
    document.addEventListener('mouseup', () => {
        if (isDragging) {
            isDragging = false;
            pip.classList.remove('dragging');
        }
    });
}
    </script>
</body>
</html>
