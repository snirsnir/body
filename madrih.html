<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×˜×›× ×•-×œ×™×™×‘ - ×¤×× ×œ ××“×¨×™×š</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            min-height: 100vh;
            direction: rtl;
            color: white;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            height: 100vh;
            display: flex;
            gap: 20px;
        }

        /* Left Panel - Main Control */
        .main-panel {
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .logo {
            font-size: 1.8em;
            font-weight: bold;
            color: #3498db;
        }

        .session-controls {
            display: flex;
            gap: 15px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1em;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Session Setup */
        .session-setup {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #ecf0f1;
        }

        .form-input {
            width: 100%;
            padding: 10px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1em;
        }

        .form-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        /* Live Controls */
        .live-controls {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .live-video {
            width: 100%;
            height: 200px;
            background: #000;
            border-radius: 10px;
            margin-bottom: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #666;
        }

        .control-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
        }

        /* Navigation Controls */
        .navigation-controls {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .current-activity {
            text-align: center;
            margin-bottom: 15px;
            font-size: 1.1em;
            color: #3498db;
        }

        /* Participants Panel */
        .participants-panel {
            flex: 1;
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
        }

        .participants-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .participants-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .participant-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin-bottom: 5px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
        }

        .participant-name {
            font-weight: bold;
        }

        .participant-score {
            background: #3498db;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.9em;
        }

        /* Right Panel - Timeline */
        .timeline-panel {
            width: 300px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }

        .timeline-header {
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.2em;
            color: #3498db;
        }

        .timeline-items {
            flex: 1;
            overflow-y: auto;
        }

        .timeline-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            cursor: move;
            transition: all 0.3s;
            border-right: 4px solid transparent;
        }

        .timeline-item:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .timeline-item.current {
            border-right-color: #3498db;
            background: rgba(52, 152, 219, 0.2);
        }

        .timeline-item.completed {
            opacity: 0.6;
            border-right-color: #27ae60;
        }

        .item-title {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .item-type {
            font-size: 0.9em;
            color: #bdc3c7;
        }

        .add-item-btn {
            width: 100%;
            margin-top: 10px;
        }

        /* Status Indicators */
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-left: 8px;
        }

        .status-live {
            background: #e74c3c;
            animation: pulse 2s infinite;
        }

        .status-ready {
            background: #27ae60;
        }

        .status-waiting {
            background: #f39c12;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* Modal for adding activities */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #2c3e50;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5em;
            cursor: pointer;
        }

        .activity-types {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .activity-type {
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .activity-type:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .activity-type.selected {
            background: rgba(52, 152, 219, 0.3);
            border: 2px solid #3498db;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Main Panel -->
        <div class="main-panel">
            <div class="header">
                <div class="logo">ğŸ¯ ×˜×›× ×•-×œ×™×™×‘ - ×¤×× ×œ ××“×¨×™×š</div>
                <div class="session-controls">
                    <span id="sessionStatus">×œ× ××—×•×‘×¨</span>
                    <div class="status-indicator" id="statusIndicator"></div>
                </div>
            </div>

            <!-- Session Setup -->
            <div class="session-setup">
                <h3 style="margin-bottom: 15px;">×”×’×“×¨×ª ×¡×©×Ÿ</h3>
                <div class="form-group">
                    <label class="form-label">××–×”×” ×¡×©×Ÿ:</label>
                    <input type="text" class="form-input" id="sessionIdInput" placeholder="×œ×“×•×’××”: 2025-06-16-morning">
                </div>
                <div class="form-group">
                    <label class="form-label">×–××Ÿ ×”×ª×—×œ×” (×“×§×•×ª ××”×¢×ª):</label>
                    <input type="number" class="form-input" id="startTimeInput" value="5" min="1" max="60">
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-warning" id="copyLinkBtn" onclick="copySessionLink()" style="display: none;">
                        ğŸ“‹ ×”×¢×ª×§ ×§×™×©×•×¨
                    </button>
                    <button class="btn btn-primary" onclick="createSession()">×¦×•×¨ ×¡×©×Ÿ ×—×“×©</button>
                    <button class="btn btn-success" onclick="loadSession()">×˜×¢×Ÿ ×¡×©×Ÿ ×§×™×™×</button>
                </div>
            </div>

            <!-- Live Controls -->
            <div class="live-controls" id="liveControls" style="display: none;">
                <h3 style="margin-bottom: 15px;">×‘×§×¨×ª ×©×™×“×•×¨ ×—×™</h3>
                <video class="live-video" id="liveVideo" autoplay muted style="width: 100%; height: 200px; object-fit: cover;"></video>
<!-- ×‘×ª×•×š live-controls -->
<div class="control-buttons">
    <button class="btn btn-danger" id="liveBtn" onclick="toggleLive()">ğŸ”´ ×”×ª×—×œ ×©×™×“×•×¨ ×—×™</button>
    <button class="btn btn-warning" id="chatBtn" onclick="toggleChat()">ğŸ’¬ ×›×‘×” ×¦'××˜</button>
    <button class="btn btn-primary" onclick="resetCamera()">ğŸ”„ ××™×¤×•×¡ ××¦×œ××”</button>
  <button class="btn btn-danger" onclick="returnToLive()" id="returnToLiveBtn" style="display: none;">
        ğŸ“º ×—×–×¨×” ×œ×©×™×“×•×¨ ×—×™
    </button>
</div>
                <div id="streamStatus" style="text-align: center; margin-top: 10px; color: #bdc3c7;"></div>
            </div>

            <!-- Navigation Controls -->
<!-- Navigation Controls -->
<div class="navigation-controls" id="navigationControls" style="display: none;">
    <h3 style="margin-bottom: 15px;">× ×™×•×•×˜ ×‘×¤×¢×™×œ×•×™×•×ª</h3>
    <div class="current-activity" id="currentActivityDisplay">
        ×¤×¢×™×œ×•×ª × ×•×›×—×™×ª: ×œ× × ×‘×—×¨×”
    </div>
    <div class="nav-buttons">
        <button class="btn btn-primary" onclick="previousActivity()">â®ï¸ ×§×•×“×</button>
        <button class="btn btn-success" onclick="nextActivity()">â­ï¸ ×”×‘×</button>
        <button class="btn btn-warning" onclick="showCountdown()">â° ×”×¦×’ ×©×¢×•×Ÿ</button>
        <!-- âœ… ×”×•×¡×£ ××ª ×”×›×¤×ª×•×¨ ×”×—×“×© -->

    </div>
</div>

            <!-- Participants Panel -->
            <div class="participants-panel" id="participantsPanel" style="display: none;">
                <div class="participants-header">
                    <h3>××©×ª×ª×¤×™×</h3>
                    <span id="participantCount">0 ××©×ª×ª×¤×™×</span>
                </div>
                <div class="participants-list" id="participantsList">
                    <!-- Participants will be loaded here -->
                </div>
                <button class="btn btn-primary" onclick="showLeaderboard()" style="width: 100%; margin-top: 15px;">
                    ğŸ† ×”×¦×’ ×œ×•×— ×ª×•×¦××•×ª
                </button>
            </div>
        </div>

        <!-- Timeline Panel -->
        <div class="timeline-panel">
            <div class="timeline-header">
                <h3>×¨×¦×£ ×”×¤×¢×™×œ×•×™×•×ª</h3>
                <div style="font-size: 0.9em; color: #bdc3c7; margin-top: 5px;">
                    ×’×¨×•×¨ ×œ×©×™× ×•×™ ×¡×“×¨
                </div>
            </div>
            <div class="timeline-items" id="timelineItems">
                <!-- Timeline items will be loaded here -->
            </div>
            <button class="btn btn-primary add-item-btn" onclick="showAddActivityModal()">
                â• ×”×•×¡×£ ×¤×¢×™×œ×•×ª
            </button>
        </div>
    </div>

    <!-- Add Activity Modal -->
    <div class="modal" id="addActivityModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>×”×•×¡×£ ×¤×¢×™×œ×•×ª ×—×“×©×”</h3>
                <button class="close-btn" onclick="closeAddActivityModal()">&times;</button>
            </div>
            
            <div class="activity-types">
                <div class="activity-type" onclick="selectActivityType('live')">
                    <div style="font-size: 2em; margin-bottom: 10px;">ğŸ¥</div>
                    <div>×©×™×“×•×¨ ×—×™</div>
                </div>
                <div class="activity-type" onclick="selectActivityType('iframe')">
                    <div style="font-size: 2em; margin-bottom: 10px;">ğŸ®</div>
                    <div>××©×—×§/×¤×¢×™×œ×•×ª</div>
                </div>
                <div class="activity-type" onclick="selectActivityType('question')">
                    <div style="font-size: 2em; margin-bottom: 10px;">â“</div>
                    <div>×©××œ×” ×××¨×™×§××™×ª</div>
                </div>
                <div class="activity-type" onclick="selectActivityType('break')">
                    <div style="font-size: 2em; margin-bottom: 10px;">â˜•</div>
                    <div>×”×¤×¡×§×”</div>
                </div>
            </div>

            <div id="activityForm">
                <div class="form-group">
                    <label class="form-label">×©× ×”×¤×¢×™×œ×•×ª:</label>
                    <input type="text" class="form-input" id="activityName" placeholder="×”×›× ×¡ ×©× ×œ×¤×¢×™×œ×•×ª">
                </div>
                
                <div id="iframeForm" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">×§×™×©×•×¨ ×œ×¤×¢×™×œ×•×ª:</label>
                        <input type="text" class="form-input" id="activityUrl" placeholder="games/game1.html">
                    </div>
                </div>

                <div id="questionForm" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">×©××œ×”:</label>
                        <input type="text" class="form-input" id="questionText" placeholder="××” ×”×©××œ×”?">
                    </div>
                    <div class="form-group">
                        <label class="form-label">×ª×©×•×‘×•×ª (×”×¤×¨×“ ×‘×¤×¡×™×§×™×):</label>
                        <input type="text" class="form-input" id="questionAnswers" placeholder="×ª×©×•×‘×” 1, ×ª×©×•×‘×” 2, ×ª×©×•×‘×” 3, ×ª×©×•×‘×” 4">
                    </div>
                    <div class="form-group">
                        <label class="form-label">×ª×©×•×‘×” × ×›×•× ×” (××¡×¤×¨):</label>
                        <input type="number" class="form-input" id="correctAnswer" min="1" max="4" value="1">
                    </div>
                    <div class="form-group">
                        <label class="form-label">×–××Ÿ ×œ×©××œ×” (×©× ×™×•×ª):</label>
                        <input type="number" class="form-input" id="questionTime" value="30" min="10" max="60">
                    </div>
                </div>

                <div id="breakForm" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">×–××Ÿ ×”×¤×¡×§×” (×“×§×•×ª):</label>
                        <input type="number" class="form-input" id="breakTime" value="5" min="1" max="30">
                    </div>
                </div>
            </div>

            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                <button class="btn btn-primary" onclick="addActivity()">×”×•×¡×£</button>
                <button class="btn" onclick="closeAddActivityModal()" style="background: #95a5a6;">×‘×™×˜×•×œ</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAfQaiAEs__1bQ1u6eO_W0kBjdo5yOCGmw",
            authDomain: "technolive-d5b92.firebaseapp.com",
            databaseURL: "https://technolive-d5b92-default-rtdb.firebaseio.com",
            projectId: "technolive-d5b92",
            storageBucket: "technolive-d5b92.firebasestorage.app",
            messagingSenderId: "999834099575",
            appId: "1:999834099575:web:58e8bb95b47f431159cb72"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Global Variables
        let currentSessionId = null;
        let timeline = [];
        let currentActivityIndex = -1;
        let isLive = false;
        let isChatEnabled = true;
        let selectedActivityType = null;
        let localStream = null;
        let isStreaming = false;
        
        // WebRTC Variables
        let peerConnections = new Map(); // Multiple connections for multiple students
        let connectedStudents = new Set();
        
        // WebRTC Configuration
        const rtcConfig = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' },
                { urls: 'stun:stun2.l.google.com:19302' }
            ]
        };

        // Initialize camera
// Initialize camera
// Initialize camera
async function initializeCamera() {
    try {
        // ×¢×¦×•×¨ ×–×¨× ×§×™×™×
        if (localStream) {
            localStream.getTracks().forEach(track => track.stop());
            localStream = null;
        }
        
        // × ×¡×” ×¢× ×”×’×“×¨×•×ª ×¡×¤×¦×™×¤×™×•×ª ×•×§×¤×“× ×™×•×ª
        const videoConstraints = {
            width: { min: 640, ideal: 1280, max: 1920 },
            height: { min: 480, ideal: 720, max: 1080 },
            frameRate: { min: 15, ideal: 30, max: 60 },
            facingMode: 'user'
        };
        
        console.log('ğŸ¥ ×× ×¡×” ×œ×§×‘×œ ××¦×œ××” ×¢× ×”×’×“×¨×•×ª:', videoConstraints);
        
        localStream = await navigator.mediaDevices.getUserMedia({ 
            video: videoConstraints,
            audio: {
                echoCancellation: true,
                noiseSuppression: true,
                sampleRate: 44100
            }
        });
        
        // ×‘×“×™×§×” ××™×™×“×™×ª ×©×œ ××™×›×•×ª ×”×–×¨×
        const videoTrack = localStream.getVideoTracks()[0];
        const settings = videoTrack.getSettings();
        
        console.log('ğŸ” ×”×’×“×¨×•×ª ××¦×œ××” ×‘×¤×•×¢×œ:', settings);
        
        if (settings.width < 640 || settings.height < 480) {
            console.error('âŒ ×”××¦×œ××” ×”×—×–×™×¨×” ×¨×–×•×œ×•×¦×™×” × ××•×›×”, ×× ×¡×” ×©×•×‘...');
            
            // ×¢×¦×•×¨ ×•× ×¡×” ×©×•×‘ ×¢× ×”×’×“×¨×•×ª ××—×¨×•×ª
            localStream.getTracks().forEach(track => track.stop());
            
            localStream = await navigator.mediaDevices.getUserMedia({ 
                video: {
                    width: 1280,
                    height: 720,
                    frameRate: 30
                },
                audio: true
            });
            
            const newSettings = localStream.getVideoTracks()[0].getSettings();
            console.log('ğŸ” ×”×’×“×¨×•×ª ××¦×œ××” ×©× ×™×•×ª:', newSettings);
        }
        
        // Debug ××¤×•×¨×˜
        console.log('ğŸ” Admin stream debug ××¤×•×¨×˜:', {
            streamExists: !!localStream,
            streamId: localStream.id,
            streamActive: localStream.active,
            totalTracks: localStream.getTracks().length,
            videoTracks: localStream.getVideoTracks().length,
            audioTracks: localStream.getAudioTracks().length,
            videoTrackDetails: localStream.getVideoTracks().map(track => ({
                id: track.id,
                kind: track.kind,
                enabled: track.enabled,
                readyState: track.readyState,
                muted: track.muted,
                label: track.label,
                settings: track.getSettings()
            }))
        });

        document.getElementById('liveVideo').srcObject = localStream;
        
        // ×‘×“×™×§×” ×× ×”××“×¨×™×š ×™×›×•×œ ×œ×¨××•×ª ××ª ×¢×¦××•
        const adminVideo = document.getElementById('liveVideo');
        
        adminVideo.onloadedmetadata = () => {
            console.log('ğŸ” Admin video element:', {
                hasSource: !!adminVideo.srcObject,
                videoWidth: adminVideo.videoWidth,
                videoHeight: adminVideo.videoHeight,
                readyState: adminVideo.readyState
            });
            
            if (adminVideo.videoWidth <= 2 || adminVideo.videoHeight <= 2) {
                console.error('âŒ ××¦×œ××ª ×”××“×¨×™×š ×—×–×¨×” ×¨×–×•×œ×•×¦×™×” × ××•×›×”!');
                alert('×‘×¢×™×” ×‘××¦×œ××”! ×”××¦×œ××” ××—×–×™×¨×” ×¨×–×•×œ×•×¦×™×” × ××•×›×” ××“×™.');
                return;
            }
        };
        
        console.log('âœ… ××¦×œ××” ××•×›× ×” ×‘×”×¦×œ×—×”');
        updateStreamStatus('××¦×œ××” ××•×›× ×”');
        
    } catch (error) {
        console.error('âŒ ×©×’×™××” ×‘×’×™×©×” ×œ××¦×œ××”:', error);
        alert('×œ× × ×™×ª×Ÿ ×œ×’×©×ª ×œ××¦×œ××”. ×‘×“×•×§ ×”×¨×©××•×ª.');
        updateStreamStatus('×©×’×™××” ×‘××¦×œ××”');
    }
}

        // Update stream status
        function updateStreamStatus(status) {
            document.getElementById('streamStatus').textContent = status;
        }

        // Create new session
// Create new session
function createSession() {
    const sessionIdInput = document.getElementById('sessionIdInput');
    const startTimeInput = document.getElementById('startTimeInput');
    
    const sessionId = sessionIdInput.value.trim();
    const startMinutes = parseInt(startTimeInput.value) || 5;
    
    if (!sessionId) {
        alert('× × ×œ×”×›× ×™×¡ ××–×”×” ×¡×©×Ÿ');
        return;
    }

    currentSessionId = sessionId;
    const startTime = Date.now() + (startMinutes * 60 * 1000);

    // âœ… ×¤×¢×™×œ×•×™×•×ª ×“×™×¤×•×œ×˜×™×‘×™×•×ª
    const defaultTimeline = [
        {
            id: Date.now() + 1,
            name: "×¡×¨×˜×•×Ÿ ×¤×ª×™×—×”",
            type: "iframe",
            url: "https://www.youtube.com/embed/swM0z9TOfMQ"
        },
        {
            id: Date.now() + 2,
            name: "×¡×¨×˜×•×Ÿ ×—×™×“×” ×¢×™× ×™×™×",
            type: "iframe",
            url: "https://www.youtube.com/embed/Ugr9aYJNZbU"
        },
        {
            id: Date.now() + 3,
            name: "×¡×¨×˜×•×Ÿ ×—×™×“×” ××•×–× ×™×™×",
            type: "iframe",
            url: "https://www.youtube.com/embed/Dbwy2-DZxmM"
        },
        {
            id: Date.now() + 4,
            name: "×¡×¨×˜×•×Ÿ ×—×™×“×” ××£",
            type: "iframe",
            url: "https://www.youtube.com/embed/STE1RTNRCZA"
        },
        {
            id: Date.now() + 5,
            name: "××•×–×™××•×Ÿ 360",
            type: "iframe",
            url: "https://kuula.co/share/hHTCt?logo=0&info=0&fs=1&vr=1&sd=1&initload=0&thumbs=1"
        },
        {
            id: Date.now() + 6,
            name: "××©×—×§ ××™×‘×¨×™×",
            type: "iframe",
            url: "https://view.genially.com/684fb8017e74465fc6cd1cc1"
        },
        {
            id: Date.now() + 7,
            name: "×¡×¨×˜×•×Ÿ ×—×™×“×” ×™×“×™×™×",
            type: "iframe",
            url: "https://www.youtube.com/embed/sVxDzWyeSkw"
        },
        {
            id: Date.now() + 8,
            name: "×¡×¨×˜×•×Ÿ ×—×™×“×” ×¢×•×¨",
            type: "iframe",
            url: "https://www.youtube.com/embed/ZjKP85gfQxE"
        },
        {
            id: Date.now() + 9,
            name: "×¡×¨×˜×•×Ÿ ×—×™×“×” ×›×œ×™×•×ª",
            type: "iframe",
            url: "https://www.youtube.com/embed/yZVIc-_7KSQ"
        },
        {
            id: Date.now() + 10,
            name: "××©×—×§ ×¡×•×œ××•×ª ×•× ×—×©×™×",
            type: "iframe",
            url: "liron.html"
        }
    ];

    // Create session in Firebase
    database.ref(`sessions/${sessionId}`).set({
        createdAt: Date.now(),
        startTime: startTime,
        status: 'waiting',
        currentActivity: {
            type: 'countdown',
            endTime: startTime
        },
        chatEnabled: true,
        timeline: defaultTimeline, // âœ… ×”×•×¡×£ ××ª ×”×¤×¢×™×œ×•×™×•×ª ×”×“×™×¤×•×œ×˜×™×‘×™×•×ª
        participants: {},
        chat: {},
        webrtc: {}
    }).then(() => {
        alert(`×¡×©×Ÿ × ×•×¦×¨ ×‘×”×¦×œ×—×”!\n×§×™×©×•×¨ ×œ××©×ª×ª×¤×™×: ${window.location.origin}${window.location.pathname.replace('admin.html', 'index.html')}?session=${sessionId}`);
        
        // âœ… ×¢×“×›×Ÿ ××ª ×”timeline ×”××§×•××™
        timeline = defaultTimeline;
        currentActivityIndex = -1;
        
        initializeSession();
        loadTimeline(); // âœ… ×˜×¢×Ÿ ××ª ×”×¤×¢×™×œ×•×™×•×ª ×œ×ª×¦×•×’×”
    }).catch((error) => {
        console.error('×©×’×™××” ×‘×™×¦×™×¨×ª ×¡×©×Ÿ:', error);
        alert('×©×’×™××” ×‘×™×¦×™×¨×ª ×”×¡×©×Ÿ');
    });
}

        // Load existing session
        function loadSession() {
            const sessionIdInput = document.getElementById('sessionIdInput');
            const sessionId = sessionIdInput.value.trim();
            
            if (!sessionId) {
                alert('× × ×œ×”×›× ×™×¡ ××–×”×” ×¡×©×Ÿ');
                return;
            }

            // Check if session exists
            database.ref(`sessions/${sessionId}`).once('value', (snapshot) => {
                if (snapshot.exists()) {
                    currentSessionId = sessionId;
                    const sessionData = snapshot.val();
                    timeline = sessionData.timeline || [];
                    currentActivityIndex = sessionData.currentActivityIndex || -1;
                    initializeSession();
                    loadTimeline();
                } else {
                    alert('×”×¡×©×Ÿ ×œ× ×§×™×™×');
                }
            });
        }

        // Initialize session UI
        function initializeSession() {
            document.getElementById('sessionStatus').textContent = `××—×•×‘×¨ ×œ×¡×©×Ÿ: ${currentSessionId}`;
            document.getElementById('statusIndicator').className = 'status-indicator status-ready';
            
            // Show control panels
            document.getElementById('liveControls').style.display = 'block';
            document.getElementById('navigationControls').style.display = 'block';
            document.getElementById('participantsPanel').style.display = 'block';
            
            // Listen to participants
            listenToParticipants();
            
            // Listen to WebRTC answers
            listenToWebRTCAnswers();
            
            // Update session link
            updateSessionLink();
            // Show copy link button
            document.getElementById('copyLinkBtn').style.display = 'block';
            // Initialize camera when session starts
            initializeCamera();
        }

        // Listen to WebRTC answers and ICE candidates
// Listen to WebRTC answers and ICE candidates
function listenToWebRTCAnswers() {
    console.log('ğŸ§ ××ª×—×™×œ ×œ×”××–×™×Ÿ ×œ×ª×©×•×‘×•×ª WebRTC...');
    
    // ×”××–×Ÿ ×œ×ª×©×•×‘×•×ª ×œ×¤×™ ××©×ª×ª×£ - ×ª×™×§×•×Ÿ ×”× ×ª×™×‘
    database.ref(`sessions/${currentSessionId}/webrtc/answers`).on('child_added', async (snapshot) => {
        const participantId = snapshot.key;
        const data = snapshot.val();
        
        if (data && data.answer) {
            console.log(`ğŸ“¨ ×”×ª×§×‘×œ×” ×ª×©×•×‘×” ×-${participantId}`);
            
            const pc = peerConnections.get(participantId);
            if (pc && pc.signalingState === 'have-local-offer') {
                try {
                    await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
                    console.log(`âœ… Remote description × ×§×‘×¢ ×¢×‘×•×¨ ${participantId}`);
                    connectedStudents.add(participantId);
                    updateStreamStatus(`××—×•×‘×¨ ×œ-${connectedStudents.size} ××©×ª×ª×¤×™×`);
                } catch (error) {
                    console.error(`âŒ ×©×’×™××” ×‘×§×‘×™×¢×ª remote description ×¢×‘×•×¨ ${participantId}:`, error);
                }
            } else {
                console.warn(`âš ï¸ PeerConnection ×¢×‘×•×¨ ${participantId} ×œ× ×‘××¦×‘ ××ª××™×: ${pc?.signalingState}`);
            }
        }
    });

    // ×”××–×Ÿ ×œ-ICE candidates - ×ª×™×§×•×Ÿ ×”×˜×™×¤×•×œ
    database.ref(`sessions/${currentSessionId}/webrtc/student-candidates`).on('child_added', async (snapshot) => {
        const candidateData = snapshot.val();
        
        // ×•×•×“× ×©×™×© participantId ×•-candidate ×ª×§×™×Ÿ
        if (candidateData && candidateData.participantId && candidateData.candidate) {
            const pc = peerConnections.get(candidateData.participantId);
            
            // ×‘×“×•×§ ×©×™×© peer connection ×•remote description
            if (pc && pc.remoteDescription) {
                try {
                    // ×•×“× ×©×”-candidate ×ª×§×™×Ÿ ×œ×¤× ×™ ×”×•×¡×¤×”
                    const candidate = candidateData.candidate;
                    if (candidate.candidate && (candidate.sdpMid !== null || candidate.sdpMLineIndex !== null)) {
                        await pc.addIceCandidate(new RTCIceCandidate(candidate));
                        console.log(`âœ… ICE candidate × ×•×¡×£ ×¢×‘×•×¨ ${candidateData.participantId}`);
                    } else {
                        console.warn(`âš ï¸ ICE candidate ×œ× ×ª×§×™×Ÿ ×¢×‘×•×¨ ${candidateData.participantId}:`, candidate);
                    }
                } catch (error) {
                    console.error(`âŒ ×©×’×™××” ×‘×”×•×¡×¤×ª ICE candidate ×¢×‘×•×¨ ${candidateData.participantId}:`, error);
                }
            } else {
                console.warn(`âš ï¸ PeerConnection ×œ× ××•×›×Ÿ ×¢×‘×•×¨ ${candidateData.participantId}, ××—×›×”...`);
            }
        }
    });
}

        // Listen to participants updates
        function listenToParticipants() {
            database.ref(`sessions/${currentSessionId}/participants`).on('value', (snapshot) => {
                const participants = snapshot.val() || {};
                updateParticipantsList(participants);
                
                // Create peer connections for new participants if streaming
                if (isStreaming) {
                    Object.keys(participants).forEach(participantId => {
                        if (!peerConnections.has(participantId)) {
                            createPeerConnectionForParticipant(participantId);
                        }
                    });
                }
            });
        }

        // Create peer connection for specific participant
// Create peer connection for specific participant
// Create peer connection for specific participant
// Create peer connection for specific participant
async function createPeerConnectionForParticipant(participantId) {
    try {
        console.log(`ğŸ”— ×™×•×¦×¨ ×—×™×‘×•×¨ WebRTC ×¢×‘×•×¨ ${participantId}`);
        
        const pc = new RTCPeerConnection(rtcConfig);
        peerConnections.set(participantId, pc);
        
        // Handle ICE candidates
        pc.onicecandidate = (event) => {
            if (event.candidate) {
                console.log(`ğŸ“¤ ×©×•×œ×— ICE candidate ×¢×‘×•×¨ ${participantId}`);
                
                const candidate = event.candidate;
                if (candidate.candidate && (candidate.sdpMid !== null || candidate.sdpMLineIndex !== null)) {
                    database.ref(`sessions/${currentSessionId}/webrtc/admin-candidates/${participantId}`).push({
                        candidate: candidate.candidate,
                        sdpMid: candidate.sdpMid,
                        sdpMLineIndex: candidate.sdpMLineIndex,
                        timestamp: Date.now()
                    });
                } else {
                    console.warn(`âš ï¸ ICE candidate ×œ× ×ª×§×™×Ÿ ×¢×‘×•×¨ ${participantId}, ××“×œ×’...`);
                }
            }
        };

        // Handle connection state
        pc.onconnectionstatechange = () => {
            console.log(`ğŸ”— ××¦×‘ ×—×™×‘×•×¨ ×¢×‘×•×¨ ${participantId}:`, pc.connectionState);
            if (pc.connectionState === 'connected') {
                connectedStudents.add(participantId);
                updateStreamStatus(`××—×•×‘×¨ ×œ-${connectedStudents.size} ××©×ª×ª×¤×™×`);
            } else if (pc.connectionState === 'disconnected' || pc.connectionState === 'failed') {
                connectedStudents.delete(participantId);
                updateStreamStatus(`××—×•×‘×¨ ×œ-${connectedStudents.size} ××©×ª×ª×¤×™×`);
            }
        };
// ×ª×•×¡×™×£ ××ª ×–×” ×‘×¤×•× ×§×¦×™×” createPeerConnectionForParticipant
// ××—×¨×™ ×”-connectionstatechange handler:

pc.onconnectionstatechange = async () => {
    console.log(`ğŸ”— ××¦×‘ ×—×™×‘×•×¨ ×¢×‘×•×¨ ${participantId}:`, pc.connectionState);
    if (pc.connectionState === 'connected') {
        connectedStudents.add(participantId);
        updateStreamStatus(`××—×•×‘×¨ ×œ-${connectedStudents.size} ××©×ª×ª×¤×™×`);
        
        // âœ¨ DEBUG ×—×“×©: ×‘×“×™×§×” ××” ×‘×××ª × ×©×œ×—
        const senders = pc.getSenders();
        for (const sender of senders) {
            if (sender.track && sender.track.kind === 'video') {
                const stats = await pc.getStats(sender);
                stats.forEach(report => {
                    if (report.type === 'outbound-rtp' && report.mediaType === 'video') {
                        console.log(`ğŸ“Š Stats ×¢×‘×•×¨ ${participantId}:`, {
                            width: report.frameWidth,
                            height: report.frameHeight,
                            bitrate: report.bytesSent,
                            fps: report.framesPerSecond,
                            codec: report.codecId
                        });
                    }
                });
                
                // ×’× ×‘×“×•×§ ××ª ×”×”×’×“×¨×•×ª ×©×œ ×”-track ×¢×¦××•
                const trackSettings = sender.track.getSettings();
                console.log(`ğŸ“¹ Track settings ×¢×‘×•×¨ ${participantId}:`, trackSettings);
                
                // ×‘×“×•×§ constraints
                const trackConstraints = sender.track.getConstraints();
                console.log(`ğŸ“‹ Track constraints ×¢×‘×•×¨ ${participantId}:`, trackConstraints);
            }
        }
    }
};
        // Add local stream tracks ×¢× ××™×œ×•×¥ ×¨×–×•×œ×•×¦×™×”
        if (localStream && localStream.active) {
            console.log('ğŸ“¹ ××•×¡×™×£ tracks ×œconnection:', localStream.getTracks().length);
            
            for (const track of localStream.getTracks()) {
                console.log(`ğŸ“¹ Track: ${track.kind}, enabled: ${track.enabled}, readyState: ${track.readyState}`);
                
                const sender = pc.addTrack(track, localStream);
                
                // ×ª×™×§×•×Ÿ ×—×©×•×‘: ××™×œ×•×¥ ×¨×–×•×œ×•×¦×™×” ×’×‘×•×”×” ×œ×•×™×“×™××•
                if (track.kind === 'video') {
                    // ××—×›×” ×œ×—×™×‘×•×¨ ×•××– ××’×“×™×¨ ×¤×¨××˜×¨×™×
                    pc.addEventListener('connectionstatechange', async () => {
                        if (pc.connectionState === 'connected') {
                            try {
                                const params = sender.getParameters();
                                console.log('ğŸ“‹ Current encoding params:', params);
                                
                                if (params.encodings && params.encodings.length > 0) {
                                    // ×”×’×“×¨×•×ª ××™×›×•×ª ××§×¡×™××œ×™×ª
                                    params.encodings[0].maxBitrate = 5000000; // 5 Mbps
                                    params.encodings[0].maxFramerate = 30;
                                    params.encodings[0].scaleResolutionDownBy = 1; // ×œ×œ× ×”×§×˜× ×”!
                                    
                                    // × ×¡×” ×’× ×œ×”×’×“×™×¨ ×¨×–×•×œ×•×¦×™×” ×¡×¤×¦×™×¤×™×ª
                                    if (params.encodings[0].rid === undefined) {
                                        params.encodings[0].maxWidth = 1280;
                                        params.encodings[0].maxHeight = 720;
                                    }
                                    
                                    await sender.setParameters(params);
                                    console.log('âœ… Video encoding parameters updated:', params.encodings[0]);
                                } else {
                                    console.warn('âš ï¸ ××™×Ÿ encodings ×–××™× ×™×');
                                }
                            } catch (error) {
                                console.error('âŒ ×©×’×™××” ×‘×”×’×“×¨×ª ×¤×¨××˜×¨×™×:', error);
                            }
                        }
                    });
                    
                    // ×’× ××™×“ × ×¡×” ×œ×”×’×“×™×¨
                    try {
                        const initialParams = sender.getParameters();
                        if (initialParams.encodings && initialParams.encodings.length > 0) {
                            initialParams.encodings[0].maxBitrate = 5000000;
                            initialParams.encodings[0].maxFramerate = 30;
                            initialParams.encodings[0].scaleResolutionDownBy = 1;
                            await sender.setParameters(initialParams);
                            console.log('âœ… Initial video parameters set');
                        }
                    } catch (error) {
                        console.warn('âš ï¸ Could not set initial parameters:', error);
                    }
                }
            }
        } else {
            console.error('âŒ Local stream ×œ× ×¤×¢×™×œ!', localStream);
        }
        
        console.log(`âœ… Peer connection × ×•×¦×¨ ×¢×‘×•×¨ ${participantId}`);
        
    } catch (error) {
        console.error(`âŒ ×©×’×™××” ×‘×™×¦×™×¨×ª peer connection ×¢×‘×•×¨ ${participantId}:`, error);
    }
}

        // Update participants list
        function updateParticipantsList(participants) {
            const participantsList = document.getElementById('participantsList');
            const participantCount = document.getElementById('participantCount');
            
            const participantsArray = Object.entries(participants).map(([id, data]) => ({
                id,
                ...data
            })).sort((a, b) => (b.score || 0) - (a.score || 0));
            
            participantCount.textContent = `${participantsArray.length} ××©×ª×ª×¤×™×`;
            
            participantsList.innerHTML = participantsArray.map(participant => `
                <div class="participant-item">
                    <span class="participant-name">${participant.name}</span>
                    <span class="participant-score">${participant.score || 0}</span>
                </div>
            `).join('');
        }

        // Toggle live stream
        function toggleLive() {
            if (!isStreaming) {
                startStreaming();
            } else {
                stopStreaming();
            }
        }

        async function startStreaming() {
            try {
                console.log('ğŸ¬ ××ª×—×™×œ ×©×™×“×•×¨ ×—×™...');
                
                if (!localStream) {
                    await initializeCamera();
                }
                
                if (!localStream) {
                    throw new Error('×œ× × ×™×ª×Ÿ ×œ××ª×—×œ ××¦×œ××”');
                }
                
                isStreaming = true;
                document.getElementById('liveBtn').textContent = 'â¹ï¸ ×¢×¦×•×¨ ×©×™×“×•×¨';
                document.getElementById('statusIndicator').className = 'status-indicator status-live';
                updateStreamStatus('××ª×—×™×œ ×©×™×“×•×¨...');
                
                // Clear any existing WebRTC data
                await database.ref(`sessions/${currentSessionId}/webrtc`).remove();
                
                // Create peer connections for existing participants
                const participantsSnapshot = await database.ref(`sessions/${currentSessionId}/participants`).once('value');
                const participants = participantsSnapshot.val() || {};
                
                for (const participantId of Object.keys(participants)) {
                    await createPeerConnectionForParticipant(participantId);
                }
                
                // Create and send offer
                await createAndSendOffer();
                
                // Update activity
                database.ref(`sessions/${currentSessionId}/currentActivity`).set({
                    type: 'live',
                    streaming: true,
                    timestamp: Date.now()
                });
                
                console.log('âœ… ×©×™×“×•×¨ ×—×™ ×”×ª×—×™×œ ×‘×”×¦×œ×—×”');
                        document.getElementById('returnToLiveBtn').style.display = 'none';

            } catch (error) {
                console.error('âŒ ×©×’×™××” ×‘×”×ª×—×œ×ª ×©×™×“×•×¨:', error);
                alert('×©×’×™××” ×‘×”×ª×—×œ×ª ×”×©×™×“×•×¨: ' + error.message);
                stopStreaming();
            }
        }
async function createAndSendOffer() {
    try {
        const participants = await database.ref(`sessions/${currentSessionId}/participants`).once('value');
        const participantIds = Object.keys(participants.val() || {});
        
        for (const participantId of participantIds) {
            const pc = peerConnections.get(participantId);
            if (pc) {
                // ×™×¦×™×¨×ª offer ×¢× ××™×œ×•×¥ ××™×›×•×ª ×’×‘×•×”×”
                const offer = await pc.createOffer({
                    offerToReceiveAudio: false,
                    offerToReceiveVideo: false
                });
                
                // ××™×œ×•×¥ ×¨×–×•×œ×•×¦×™×” ×‘-SDP
                let modifiedSdp = offer.sdp;
                
                // ×”×•×¡×£ bandwidth ×’×‘×•×”
                if (modifiedSdp.includes('m=video')) {
                    modifiedSdp = modifiedSdp.replace(
                        /(m=video \d+ [^\r\n]+)/,
                        '$1\r\nb=AS:5000'
                    );
                }
                
                // ×”×•×¡×£ ×¤×¨××˜×¨×™ ××™×›×•×ª ×œ×•×™×“×™××•
                modifiedSdp = modifiedSdp.replace(
                    /(a=rtpmap:\d+ H264[^\r\n]+)/g,
                    '$1\r\na=fmtp:96 profile-level-id=42e01f;level-asymmetry-allowed=1;packetization-mode=1'
                );
                
                const modifiedOffer = {
                    type: offer.type,
                    sdp: modifiedSdp
                };
                
                await pc.setLocalDescription(modifiedOffer);
                
                await database.ref(`sessions/${currentSessionId}/webrtc/offers/${participantId}`).set({
                    offer: modifiedOffer,
                    timestamp: Date.now()
                });
                
                console.log(`ğŸ“¤ High-quality offer × ×©×œ×— ×œ-${participantId}`);
            }
        }
        
        console.log('ğŸ“¤ WebRTC offers × ×©×œ×—×• ×œ×›×œ ×”××©×ª×ª×¤×™×');
        
    } catch (error) {
        console.error('âŒ ×©×’×™××” ×‘×™×¦×™×¨×ª offers:', error);
        throw error;
    }
}

        function stopStreaming() {
            try {
                console.log('â¹ï¸ ×¢×•×¦×¨ ×©×™×“×•×¨ ×—×™...');
                
                isStreaming = false;
                document.getElementById('liveBtn').textContent = 'ğŸ”´ ×”×ª×—×œ ×©×™×“×•×¨ ×—×™';
                document.getElementById('statusIndicator').className = 'status-indicator status-ready';
                updateStreamStatus('×©×™×“×•×¨ ×”×•×¤×¡×§');
                
                // Close all peer connections
                peerConnections.forEach((pc, participantId) => {
                    console.log(`ğŸ”Œ ×¡×•×’×¨ ×—×™×‘×•×¨ ×¢×‘×•×¨ ${participantId}`);
                    pc.close();
                });
                peerConnections.clear();
                connectedStudents.clear();
                
                // Clear WebRTC data
                database.ref(`sessions/${currentSessionId}/webrtc`).remove();
                
                // Update activity
                database.ref(`sessions/${currentSessionId}/currentActivity`).set({
                    type: 'live',
                    streaming: false,
                    timestamp: Date.now()
                });
                
                console.log('âœ… ×©×™×“×•×¨ ×”×•×¤×¡×§ ×‘×”×¦×œ×—×”');
                        document.getElementById('returnToLiveBtn').style.display = 'none';

            } catch (error) {
                console.error('âŒ ×©×’×™××” ×‘×”×¤×¡×§×ª ×©×™×“×•×¨:', error);
            }
        }

        // Toggle chat
        function toggleChat() {
            const chatBtn = document.getElementById('chatBtn');
            
            isChatEnabled = !isChatEnabled;
            
            if (isChatEnabled) {
                chatBtn.textContent = 'ğŸ’¬ ×›×‘×” ×¦\'××˜';
                chatBtn.className = 'btn btn-warning';
            } else {
                chatBtn.textContent = 'ğŸ’¬ ×”×¤×¢×œ ×¦\'××˜';
                chatBtn.className = 'btn btn-success';
            }
            
            // Update Firebase
            database.ref(`sessions/${currentSessionId}/chatEnabled`).set(isChatEnabled);
        }

        // Show countdown
        function showCountdown() {
            const minutes = prompt('×›××” ×“×§×•×ª ×¢×“ ×”×ª×—×œ×ª ×”×¤×¢×™×œ×•×ª?', '2');
            if (!minutes) return;
            
            const endTime = Date.now() + (parseInt(minutes) * 60 * 1000);
            
            database.ref(`sessions/${currentSessionId}/currentActivity`).set({
                type: 'countdown',
                endTime: endTime,
                timestamp: Date.now()
            });
            
            updateCurrentActivityDisplay('×©×¢×•×Ÿ ×”×¡×¤×™×¨×” ×œ××—×•×¨');
        }

        // Navigation functions
        function previousActivity() {
            if (currentActivityIndex > 0) {
                currentActivityIndex--;
                executeActivity(timeline[currentActivityIndex]);
                updateTimeline();
            }
        }

        function nextActivity() {
            if (currentActivityIndex < timeline.length - 1) {
                currentActivityIndex++;
                executeActivity(timeline[currentActivityIndex]);
                updateTimeline();
            }
        }

// Execute activity
function executeActivity(activity) {
    if (!activity) return;
    
    database.ref(`sessions/${currentSessionId}/currentActivity`).set({
        ...activity,
        timestamp: Date.now()
    });
    
    database.ref(`sessions/${currentSessionId}/currentActivityIndex`).set(currentActivityIndex);
    
    updateCurrentActivityDisplay(activity.name);
    
    // âœ… ×”×¦×’/×”×¡×ª×¨ ×›×¤×ª×•×¨ ×—×–×¨×” ×œ×©×™×“×•×¨ ×—×™
    const returnBtn = document.getElementById('returnToLiveBtn');
    if (activity.type !== 'live' && isStreaming) {
        returnBtn.style.display = 'inline-block';
    } else {
        returnBtn.style.display = 'none';
    }
}

        // Update current activity display
        function updateCurrentActivityDisplay(activityName) {
            document.getElementById('currentActivityDisplay').textContent = 
                `×¤×¢×™×œ×•×ª × ×•×›×—×™×ª: ${activityName}`;
        }

        // Show add activity modal
        function showAddActivityModal() {
            document.getElementById('addActivityModal').style.display = 'block';
        }

        // Close add activity modal
        function closeAddActivityModal() {
            document.getElementById('addActivityModal').style.display = 'none';
            selectedActivityType = null;
            clearActivityForms();
        }

        // Select activity type
        function selectActivityType(type) {
            selectedActivityType = type;
            
            // Update UI
            document.querySelectorAll('.activity-type').forEach(el => {
                el.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            // Show relevant form
            clearActivityForms();
            if (type === 'iframe') {
                document.getElementById('iframeForm').style.display = 'block';
            } else if (type === 'question') {
                document.getElementById('questionForm').style.display = 'block';
            } else if (type === 'break') {
                document.getElementById('breakForm').style.display = 'block';
            }
        }

        // Clear activity forms
        function clearActivityForms() {
            document.getElementById('iframeForm').style.display = 'none';
            document.getElementById('questionForm').style.display = 'none';
            document.getElementById('breakForm').style.display = 'none';
        }

        // Add activity
        function addActivity() {
            if (!selectedActivityType) {
                alert('× × ×œ×‘×—×•×¨ ×¡×•×’ ×¤×¢×™×œ×•×ª');
                return;
            }
            
            const activityName = document.getElementById('activityName').value.trim();
            if (!activityName) {
                alert('× × ×œ×”×›× ×™×¡ ×©× ×œ×¤×¢×™×œ×•×ª');
                return;
            }
            
            const activity = {
                id: Date.now(),
                name: activityName,
                type: selectedActivityType
            };
            
            // Add type-specific data
            if (selectedActivityType === 'iframe') {
                const url = document.getElementById('activityUrl').value.trim();
                if (!url) {
                    alert('× × ×œ×”×›× ×™×¡ ×§×™×©×•×¨');
                    return;
                }
                activity.url = url;
            } else if (selectedActivityType === 'question') {
                const questionText = document.getElementById('questionText').value.trim();
                const answers = document.getElementById('questionAnswers').value.trim();
                const correctAnswer = parseInt(document.getElementById('correctAnswer').value);
                const timeLimit = parseInt(document.getElementById('questionTime').value);
                
                if (!questionText || !answers) {
                    alert('× × ×œ××œ× ××ª ×›×œ ×”×©×“×•×ª');
                    return;
                }
                
                activity.question = questionText;
                activity.answers = answers.split(',').map(a => a.trim());
                activity.correctAnswer = correctAnswer - 1; // Zero-based index
                activity.timeLimit = timeLimit;
            } else if (selectedActivityType === 'break') {
                const breakTime = parseInt(document.getElementById('breakTime').value);
                activity.duration = breakTime * 60 * 1000; // Convert to milliseconds
            }
            
            // Add to timeline
            timeline.push(activity);
            updateTimelineInFirebase();
            loadTimeline();
            closeAddActivityModal();
        }

        // Update timeline in Firebase
        function updateTimelineInFirebase() {
            database.ref(`sessions/${currentSessionId}/timeline`).set(timeline);
        }

        // Load timeline
        function loadTimeline() {
            const timelineItems = document.getElementById('timelineItems');
            
            timelineItems.innerHTML = timeline.map((activity, index) => {
                let statusClass = '';
                if (index < currentActivityIndex) statusClass = 'completed';
                else if (index === currentActivityIndex) statusClass = 'current';
                
                let typeIcon = '';
                switch (activity.type) {
                    case 'live': typeIcon = 'ğŸ¥'; break;
                    case 'iframe': typeIcon = 'ğŸ®'; break;
                    case 'question': typeIcon = 'â“'; break;
                    case 'break': typeIcon = 'â˜•'; break;
                }
                
                return `
                    <div class="timeline-item ${statusClass}" onclick="jumpToActivity(${index})">
                        <div class="item-title">${typeIcon} ${activity.name}</div>
                        <div class="item-type">${getActivityTypeName(activity.type)}</div>
                    </div>
                `;
            }).join('');
        }

        // Get activity type name
        function getActivityTypeName(type) {
            switch (type) {
                case 'live': return '×©×™×“×•×¨ ×—×™';
                case 'iframe': return '×¤×¢×™×œ×•×ª/××©×—×§';
                case 'question': return '×©××œ×” ×××¨×™×§××™×ª';
                case 'break': return '×”×¤×¡×§×”';
                default: return type;
            }
        }

        // Jump to activity
        function jumpToActivity(index) {
            currentActivityIndex = index;
            executeActivity(timeline[index]);
            updateTimeline();
        }

        // Update timeline UI
        function updateTimeline() {
            loadTimeline();
        }

        // Show leaderboard
        function showLeaderboard() {
            database.ref(`sessions/${currentSessionId}/participants`).once('value', (snapshot) => {
                const participants = snapshot.val() || {};
                const sorted = Object.entries(participants)
                    .map(([id, data]) => ({ id, ...data }))
                    .sort((a, b) => (b.score || 0) - (a.score || 0))
                    .slice(0, 3);
                
                const leaderboardData = {
                    timestamp: Date.now(),
                    top3: sorted
                };
                
                database.ref(`sessions/${currentSessionId}/currentActivity`).set({
                    type: 'leaderboard',
                    data: leaderboardData,
                    timestamp: Date.now()
                });
                
                updateCurrentActivityDisplay('×œ×•×— ×ª×•×¦××•×ª');
            });
        }

        // Update session link
        function updateSessionLink() {
            const link = `${window.location.origin}${window.location.pathname.replace('admin.html', 'index.html')}?session=${currentSessionId}`;
            console.log('×§×™×©×•×¨ ×œ×¡×©×Ÿ:', link);
        }
        // Reset camera
// Reset camera - ×ª×™×§×•×Ÿ ××œ×
async function resetCamera() {
    console.log('ğŸ”„ ×××¤×¡ ××¦×œ××”...');
    
    // ×¢×¦×•×¨ ×©×™×“×•×¨ ×× ×¤×•×¢×œ
    const wasStreaming = isStreaming;
    if (isStreaming) {
        stopStreaming();
    }
    
    // ×¢×¦×•×¨ ××ª ×”×–×¨× ×”× ×•×›×—×™
    if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
        localStream = null;
    }
    
    // ×—×›×” ×§×¦×ª
    await new Promise(resolve => setTimeout(resolve, 1000));
    
    // ×”×¤×¢×œ ××—×“×©
    await initializeCamera();
    
    // ×× ×”×™×” ×©×™×“×•×¨, ×”×ª×—×œ ×©×•×‘
    if (wasStreaming) {
        setTimeout(() => {
            startStreaming();
        }, 2000);
    }
}

        // Copy session link to clipboard
        function copySessionLink() {
            const link = `${window.location.origin}${window.location.pathname.replace('admin.html', 'index.html')}?session=${currentSessionId}`;
            
            navigator.clipboard.writeText(link).then(() => {
                alert('×”×§×™×©×•×¨ ×”×•×¢×ª×§ ×œ×œ×•×—! ğŸ“‹\n\n' + link);
            }).catch(() => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = link;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('×”×§×™×©×•×¨ ×”×•×¢×ª×§ ×œ×œ×•×—! ğŸ“‹\n\n' + link);
            });
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            // Set default session ID
            const now = new Date();
            const defaultSessionId = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}-${now.getHours()}${String(now.getMinutes()).padStart(2, '0')}`;
            document.getElementById('sessionIdInput').value = defaultSessionId;
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            // Close all peer connections
            peerConnections.forEach(pc => pc.close());
            
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
        });
// âœ… ×¤×•× ×§×¦×™×” ×—×“×©×” - ×—×–×¨×” ×œ×©×™×“×•×¨ ×—×™
function returnToLive() {
    // ×¢×“×›×Ÿ ×œ×¤×¢×™×œ×•×ª ×©×™×“×•×¨ ×—×™
    database.ref(`sessions/${currentSessionId}/currentActivity`).set({
        type: 'live',
        streaming: isStreaming,
        timestamp: Date.now()
    });
    
    // ×¢×“×›×Ÿ ××ª ×”×ª×¦×•×’×” ×”××§×•××™×ª
    updateCurrentActivityDisplay('×©×™×“×•×¨ ×—×™');
    
    // ×”×¡×ª×¨ ××ª ×”×›×¤×ª×•×¨
    document.getElementById('returnToLiveBtn').style.display = 'none';
    
    console.log('ğŸ”„ ×—×–×¨×” ×œ×©×™×“×•×¨ ×—×™');
}
    </script>
</body>
</html>
