<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>◊ò◊õ◊†◊ï-◊ú◊ô◊ô◊ë - ◊§◊ê◊†◊ú ◊û◊ì◊®◊ô◊ö</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            min-height: 100vh;
            direction: rtl;
            color: white;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            height: 100vh;
            display: flex;
            gap: 20px;
        }

        /* Left Panel - Main Control */
        .main-panel {
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .logo {
            font-size: 1.8em;
            font-weight: bold;
            color: #3498db;
        }

        .session-controls {
            display: flex;
            gap: 15px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1em;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Session Setup */
        .session-setup {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #ecf0f1;
        }

        .form-input {
            width: 100%;
            padding: 10px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1em;
        }

        .form-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        /* Live Controls */
        .live-controls {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .live-video {
            width: 100%;
            height: 200px;
            background: #000;
            border-radius: 10px;
            margin-bottom: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #666;
        }

        .control-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
        }

        /* Navigation Controls */
        .navigation-controls {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .current-activity {
            text-align: center;
            margin-bottom: 15px;
            font-size: 1.1em;
            color: #3498db;
        }

        /* Participants Panel */
        .participants-panel {
            flex: 1;
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
        }

        .participants-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .participants-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .participant-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin-bottom: 5px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
        }

        .participant-name {
            font-weight: bold;
        }

        .participant-score {
            background: #3498db;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.9em;
        }

        /* Right Panel - Timeline */
        .timeline-panel {
            width: 300px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }

        .timeline-header {
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.2em;
            color: #3498db;
        }

        .timeline-items {
            flex: 1;
            overflow-y: auto;
        }

        .timeline-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            cursor: move;
            transition: all 0.3s;
            border-right: 4px solid transparent;
        }

        .timeline-item:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .timeline-item.current {
            border-right-color: #3498db;
            background: rgba(52, 152, 219, 0.2);
        }

        .timeline-item.completed {
            opacity: 0.6;
            border-right-color: #27ae60;
        }

        .item-title {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .item-type {
            font-size: 0.9em;
            color: #bdc3c7;
        }

        .add-item-btn {
            width: 100%;
            margin-top: 10px;
        }

        /* Status Indicators */
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-left: 8px;
        }

        .status-live {
            background: #e74c3c;
            animation: pulse 2s infinite;
        }

        .status-ready {
            background: #27ae60;
        }

        .status-waiting {
            background: #f39c12;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* Modal for adding activities */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #2c3e50;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5em;
            cursor: pointer;
        }

        .activity-types {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .activity-type {
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .activity-type:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .activity-type.selected {
            background: rgba(52, 152, 219, 0.3);
            border: 2px solid #3498db;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Main Panel -->
        <div class="main-panel">
            <div class="header">
                <div class="logo">üéØ ◊ò◊õ◊†◊ï-◊ú◊ô◊ô◊ë - ◊§◊ê◊†◊ú ◊û◊ì◊®◊ô◊ö</div>
                <div class="session-controls">
                    <span id="sessionStatus">◊ú◊ê ◊û◊ó◊ï◊ë◊®</span>
                    <div class="status-indicator" id="statusIndicator"></div>
                </div>
            </div>

            <!-- Session Setup -->
            <div class="session-setup">
                <h3 style="margin-bottom: 15px;">◊î◊í◊ì◊®◊™ ◊°◊©◊ü</h3>
                <div class="form-group">
                    <label class="form-label">◊û◊ñ◊î◊î ◊°◊©◊ü:</label>
                    <input type="text" class="form-input" id="sessionIdInput" placeholder="◊ú◊ì◊ï◊í◊û◊î: 2025-06-16-morning">
                </div>
                <div class="form-group">
                    <label class="form-label">◊ñ◊û◊ü ◊î◊™◊ó◊ú◊î (◊ì◊ß◊ï◊™ ◊û◊î◊¢◊™):</label>
                    <input type="number" class="form-input" id="startTimeInput" value="5" min="1" max="60">
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-warning" id="copyLinkBtn" onclick="copySessionLink()" style="display: none;">
                        üìã ◊î◊¢◊™◊ß ◊ß◊ô◊©◊ï◊®
                    </button>
                    <button class="btn btn-primary" onclick="createSession()">◊¶◊ï◊® ◊°◊©◊ü ◊ó◊ì◊©</button>
                    <button class="btn btn-success" onclick="loadSession()">◊ò◊¢◊ü ◊°◊©◊ü ◊ß◊ô◊ô◊ù</button>
                </div>
            </div>

            <!-- Live Controls -->
            <div class="live-controls" id="liveControls" style="display: none;">
                <h3 style="margin-bottom: 15px;">◊ë◊ß◊®◊™ ◊©◊ô◊ì◊ï◊® ◊ó◊ô</h3>
                <video class="live-video" id="liveVideo" autoplay muted style="width: 100%; height: 200px; object-fit: cover;"></video>
<!-- ◊ë◊™◊ï◊ö live-controls -->
<div class="control-buttons">
    <button class="btn btn-danger" id="liveBtn" onclick="toggleLive()">üî¥ ◊î◊™◊ó◊ú ◊©◊ô◊ì◊ï◊® ◊ó◊ô</button>
    <button class="btn btn-warning" id="chatBtn" onclick="toggleChat()">üí¨ ◊õ◊ë◊î ◊¶'◊ê◊ò</button>
    <button class="btn btn-primary" onclick="resetCamera()">üîÑ ◊ê◊ô◊§◊ï◊° ◊û◊¶◊ú◊û◊î</button>
  <button class="btn btn-danger" onclick="returnToLive()" id="returnToLiveBtn" style="display: none;">
        üì∫ ◊ó◊ñ◊®◊î ◊ú◊©◊ô◊ì◊ï◊® ◊ó◊ô
    </button>
</div>
                <div id="streamStatus" style="text-align: center; margin-top: 10px; color: #bdc3c7;"></div>
            </div>

            <!-- Navigation Controls -->
<!-- Navigation Controls -->
<div class="navigation-controls" id="navigationControls" style="display: none;">
    <h3 style="margin-bottom: 15px;">◊†◊ô◊ï◊ï◊ò ◊ë◊§◊¢◊ô◊ú◊ï◊ô◊ï◊™</h3>
    <div class="current-activity" id="currentActivityDisplay">
        ◊§◊¢◊ô◊ú◊ï◊™ ◊†◊ï◊õ◊ó◊ô◊™: ◊ú◊ê ◊†◊ë◊ó◊®◊î
    </div>
    <div class="nav-buttons">
        <button class="btn btn-primary" onclick="previousActivity()">‚èÆÔ∏è ◊ß◊ï◊ì◊ù</button>
        <button class="btn btn-success" onclick="nextActivity()">‚è≠Ô∏è ◊î◊ë◊ê</button>
        <button class="btn btn-warning" onclick="showCountdown()">‚è∞ ◊î◊¶◊í ◊©◊¢◊ï◊ü</button>
        <!-- ‚úÖ ◊î◊ï◊°◊£ ◊ê◊™ ◊î◊õ◊§◊™◊ï◊® ◊î◊ó◊ì◊© -->

    </div>
</div>

            <!-- Participants Panel -->
            <div class="participants-panel" id="participantsPanel" style="display: none;">
                <div class="participants-header">
                    <h3>◊û◊©◊™◊™◊§◊ô◊ù</h3>
                    <span id="participantCount">0 ◊û◊©◊™◊™◊§◊ô◊ù</span>
                </div>
                <div class="participants-list" id="participantsList">
                    <!-- Participants will be loaded here -->
                </div>
                <button class="btn btn-primary" onclick="showLeaderboard()" style="width: 100%; margin-top: 15px;">
                    üèÜ ◊î◊¶◊í ◊ú◊ï◊ó ◊™◊ï◊¶◊ê◊ï◊™
                </button>
            </div>
        </div>

        <!-- Timeline Panel -->
        <div class="timeline-panel">
            <div class="timeline-header">
                <h3>◊®◊¶◊£ ◊î◊§◊¢◊ô◊ú◊ï◊ô◊ï◊™</h3>
                <div style="font-size: 0.9em; color: #bdc3c7; margin-top: 5px;">
                    ◊í◊®◊ï◊® ◊ú◊©◊ô◊†◊ï◊ô ◊°◊ì◊®
                </div>
            </div>
            <div class="timeline-items" id="timelineItems">
                <!-- Timeline items will be loaded here -->
            </div>
            <button class="btn btn-primary add-item-btn" onclick="showAddActivityModal()">
                ‚ûï ◊î◊ï◊°◊£ ◊§◊¢◊ô◊ú◊ï◊™
            </button>
        </div>
    </div>

    <!-- Add Activity Modal -->
    <div class="modal" id="addActivityModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>◊î◊ï◊°◊£ ◊§◊¢◊ô◊ú◊ï◊™ ◊ó◊ì◊©◊î</h3>
                <button class="close-btn" onclick="closeAddActivityModal()">&times;</button>
            </div>
            
            <div class="activity-types">
                <div class="activity-type" onclick="selectActivityType('live')">
                    <div style="font-size: 2em; margin-bottom: 10px;">üé•</div>
                    <div>◊©◊ô◊ì◊ï◊® ◊ó◊ô</div>
                </div>
                <div class="activity-type" onclick="selectActivityType('iframe')">
                    <div style="font-size: 2em; margin-bottom: 10px;">üéÆ</div>
                    <div>◊û◊©◊ó◊ß/◊§◊¢◊ô◊ú◊ï◊™</div>
                </div>
                <div class="activity-type" onclick="selectActivityType('question')">
                    <div style="font-size: 2em; margin-bottom: 10px;">‚ùì</div>
                    <div>◊©◊ê◊ú◊î ◊ê◊û◊®◊ô◊ß◊ê◊ô◊™</div>
                </div>
                <div class="activity-type" onclick="selectActivityType('break')">
                    <div style="font-size: 2em; margin-bottom: 10px;">‚òï</div>
                    <div>◊î◊§◊°◊ß◊î</div>
                </div>
            </div>

            <div id="activityForm">
                <div class="form-group">
                    <label class="form-label">◊©◊ù ◊î◊§◊¢◊ô◊ú◊ï◊™:</label>
                    <input type="text" class="form-input" id="activityName" placeholder="◊î◊õ◊†◊° ◊©◊ù ◊ú◊§◊¢◊ô◊ú◊ï◊™">
                </div>
                
                <div id="iframeForm" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">◊ß◊ô◊©◊ï◊® ◊ú◊§◊¢◊ô◊ú◊ï◊™:</label>
                        <input type="text" class="form-input" id="activityUrl" placeholder="games/game1.html">
                    </div>
                </div>

                <div id="questionForm" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">◊©◊ê◊ú◊î:</label>
                        <input type="text" class="form-input" id="questionText" placeholder="◊û◊î ◊î◊©◊ê◊ú◊î?">
                    </div>
                    <div class="form-group">
                        <label class="form-label">◊™◊©◊ï◊ë◊ï◊™ (◊î◊§◊®◊ì ◊ë◊§◊°◊ô◊ß◊ô◊ù):</label>
                        <input type="text" class="form-input" id="questionAnswers" placeholder="◊™◊©◊ï◊ë◊î 1, ◊™◊©◊ï◊ë◊î 2, ◊™◊©◊ï◊ë◊î 3, ◊™◊©◊ï◊ë◊î 4">
                    </div>
                    <div class="form-group">
                        <label class="form-label">◊™◊©◊ï◊ë◊î ◊†◊õ◊ï◊†◊î (◊û◊°◊§◊®):</label>
                        <input type="number" class="form-input" id="correctAnswer" min="1" max="4" value="1">
                    </div>
                    <div class="form-group">
                        <label class="form-label">◊ñ◊û◊ü ◊ú◊©◊ê◊ú◊î (◊©◊†◊ô◊ï◊™):</label>
                        <input type="number" class="form-input" id="questionTime" value="30" min="10" max="60">
                    </div>
                </div>

                <div id="breakForm" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">◊ñ◊û◊ü ◊î◊§◊°◊ß◊î (◊ì◊ß◊ï◊™):</label>
                        <input type="number" class="form-input" id="breakTime" value="5" min="1" max="30">
                    </div>
                </div>
            </div>

            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                <button class="btn btn-primary" onclick="addActivity()">◊î◊ï◊°◊£</button>
                <button class="btn" onclick="closeAddActivityModal()" style="background: #95a5a6;">◊ë◊ô◊ò◊ï◊ú</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAfQaiAEs__1bQ1u6eO_W0kBjdo5yOCGmw",
            authDomain: "technolive-d5b92.firebaseapp.com",
            databaseURL: "https://technolive-d5b92-default-rtdb.firebaseio.com",
            projectId: "technolive-d5b92",
            storageBucket: "technolive-d5b92.firebasestorage.app",
            messagingSenderId: "999834099575",
            appId: "1:999834099575:web:58e8bb95b47f431159cb72"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Global Variables
        let currentSessionId = null;
        let timeline = [];
        let currentActivityIndex = -1;
        let isLive = false;
        let isChatEnabled = true;
        let selectedActivityType = null;
        let localStream = null;
        let isStreaming = false;
        
        // WebRTC Variables
        let peerConnections = new Map(); // Multiple connections for multiple students
        let connectedStudents = new Set();
        
        // WebRTC Configuration
        const rtcConfig = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' },
                { urls: 'stun:stun2.l.google.com:19302' }
            ]
        };

        // Initialize camera
// Initialize camera
// Initialize camera
async function initializeCamera() {
    try {
        // ◊¢◊¶◊ï◊® ◊ñ◊®◊ù ◊ß◊ô◊ô◊ù
        if (localStream) {
            localStream.getTracks().forEach(track => track.stop());
            localStream = null;
        }
        
        // ◊†◊°◊î ◊¢◊ù ◊î◊í◊ì◊®◊ï◊™ ◊°◊§◊¶◊ô◊§◊ô◊ï◊™ ◊ï◊ß◊§◊ì◊†◊ô◊ï◊™
        const videoConstraints = {
            width: { min: 640, ideal: 1280, max: 1920 },
            height: { min: 480, ideal: 720, max: 1080 },
            frameRate: { min: 15, ideal: 30, max: 60 },
            facingMode: 'user'
        };
        
        console.log('üé• ◊û◊†◊°◊î ◊ú◊ß◊ë◊ú ◊û◊¶◊ú◊û◊î ◊¢◊ù ◊î◊í◊ì◊®◊ï◊™:', videoConstraints);
        
        localStream = await navigator.mediaDevices.getUserMedia({ 
            video: videoConstraints,
            audio: {
                echoCancellation: true,
                noiseSuppression: true,
                sampleRate: 44100
            }
        });
        
        // ◊ë◊ì◊ô◊ß◊î ◊û◊ô◊ô◊ì◊ô◊™ ◊©◊ú ◊ê◊ô◊õ◊ï◊™ ◊î◊ñ◊®◊ù
        const videoTrack = localStream.getVideoTracks()[0];
        const settings = videoTrack.getSettings();
        
        console.log('üîç ◊î◊í◊ì◊®◊ï◊™ ◊û◊¶◊ú◊û◊î ◊ë◊§◊ï◊¢◊ú:', settings);
        
        if (settings.width < 640 || settings.height < 480) {
            console.error('‚ùå ◊î◊û◊¶◊ú◊û◊î ◊î◊ó◊ñ◊ô◊®◊î ◊®◊ñ◊ï◊ú◊ï◊¶◊ô◊î ◊†◊û◊ï◊õ◊î, ◊û◊†◊°◊î ◊©◊ï◊ë...');
            
            // ◊¢◊¶◊ï◊® ◊ï◊†◊°◊î ◊©◊ï◊ë ◊¢◊ù ◊î◊í◊ì◊®◊ï◊™ ◊ê◊ó◊®◊ï◊™
            localStream.getTracks().forEach(track => track.stop());
            
            localStream = await navigator.mediaDevices.getUserMedia({ 
                video: {
                    width: 1280,
                    height: 720,
                    frameRate: 30
                },
                audio: true
            });
            
            const newSettings = localStream.getVideoTracks()[0].getSettings();
            console.log('üîç ◊î◊í◊ì◊®◊ï◊™ ◊û◊¶◊ú◊û◊î ◊©◊†◊ô◊ï◊™:', newSettings);
        }
        
        // Debug ◊û◊§◊ï◊®◊ò
        console.log('üîç Admin stream debug ◊û◊§◊ï◊®◊ò:', {
            streamExists: !!localStream,
            streamId: localStream.id,
            streamActive: localStream.active,
            totalTracks: localStream.getTracks().length,
            videoTracks: localStream.getVideoTracks().length,
            audioTracks: localStream.getAudioTracks().length,
            videoTrackDetails: localStream.getVideoTracks().map(track => ({
                id: track.id,
                kind: track.kind,
                enabled: track.enabled,
                readyState: track.readyState,
                muted: track.muted,
                label: track.label,
                settings: track.getSettings()
            }))
        });

        document.getElementById('liveVideo').srcObject = localStream;
        
        // ◊ë◊ì◊ô◊ß◊î ◊ê◊ù ◊î◊û◊ì◊®◊ô◊ö ◊ô◊õ◊ï◊ú ◊ú◊®◊ê◊ï◊™ ◊ê◊™ ◊¢◊¶◊û◊ï
        const adminVideo = document.getElementById('liveVideo');
        
        adminVideo.onloadedmetadata = () => {
            console.log('üîç Admin video element:', {
                hasSource: !!adminVideo.srcObject,
                videoWidth: adminVideo.videoWidth,
                videoHeight: adminVideo.videoHeight,
                readyState: adminVideo.readyState
            });
            
            if (adminVideo.videoWidth <= 2 || adminVideo.videoHeight <= 2) {
                console.error('‚ùå ◊û◊¶◊ú◊û◊™ ◊î◊û◊ì◊®◊ô◊ö ◊ó◊ñ◊®◊î ◊®◊ñ◊ï◊ú◊ï◊¶◊ô◊î ◊†◊û◊ï◊õ◊î!');
                alert('◊ë◊¢◊ô◊î ◊ë◊û◊¶◊ú◊û◊î! ◊î◊û◊¶◊ú◊û◊î ◊û◊ó◊ñ◊ô◊®◊î ◊®◊ñ◊ï◊ú◊ï◊¶◊ô◊î ◊†◊û◊ï◊õ◊î ◊û◊ì◊ô.');
                return;
            }
        };
        
        console.log('‚úÖ ◊û◊¶◊ú◊û◊î ◊û◊ï◊õ◊†◊î ◊ë◊î◊¶◊ú◊ó◊î');
        updateStreamStatus('◊û◊¶◊ú◊û◊î ◊û◊ï◊õ◊†◊î');
        
    } catch (error) {
        console.error('‚ùå ◊©◊í◊ô◊ê◊î ◊ë◊í◊ô◊©◊î ◊ú◊û◊¶◊ú◊û◊î:', error);
        alert('◊ú◊ê ◊†◊ô◊™◊ü ◊ú◊í◊©◊™ ◊ú◊û◊¶◊ú◊û◊î. ◊ë◊ì◊ï◊ß ◊î◊®◊©◊ê◊ï◊™.');
        updateStreamStatus('◊©◊í◊ô◊ê◊î ◊ë◊û◊¶◊ú◊û◊î');
    }
}

        // Update stream status
        function updateStreamStatus(status) {
            document.getElementById('streamStatus').textContent = status;
        }

        // Create new session
// Create new session
function createSession() {
    const sessionIdInput = document.getElementById('sessionIdInput');
    const startTimeInput = document.getElementById('startTimeInput');
    
    const sessionId = sessionIdInput.value.trim();
    const startMinutes = parseInt(startTimeInput.value) || 5;
    
    if (!sessionId) {
        alert('◊†◊ê ◊ú◊î◊õ◊†◊ô◊° ◊û◊ñ◊î◊î ◊°◊©◊ü');
        return;
    }

    currentSessionId = sessionId;
    const startTime = Date.now() + (startMinutes * 60 * 1000);

    // ‚úÖ ◊§◊¢◊ô◊ú◊ï◊ô◊ï◊™ ◊ì◊ô◊§◊ï◊ú◊ò◊ô◊ë◊ô◊ï◊™
    const defaultTimeline = [
        {
            id: Date.now() + 1,
            name: "◊°◊®◊ò◊ï◊ü ◊§◊™◊ô◊ó◊î",
            type: "iframe",
            url: "https://www.youtube.com/embed/swM0z9TOfMQ"
        },
        {
            id: Date.now() + 2,
            name: "◊°◊®◊ò◊ï◊ü ◊ó◊ô◊ì◊î ◊¢◊ô◊†◊ô◊ô◊ù",
            type: "iframe",
            url: "https://www.youtube.com/embed/Ugr9aYJNZbU"
        },
        {
            id: Date.now() + 3,
            name: "◊°◊®◊ò◊ï◊ü ◊ó◊ô◊ì◊î ◊ê◊ï◊ñ◊†◊ô◊ô◊ù",
            type: "iframe",
            url: "https://www.youtube.com/embed/Dbwy2-DZxmM"
        },
        {
            id: Date.now() + 4,
            name: "◊°◊®◊ò◊ï◊ü ◊ó◊ô◊ì◊î ◊ê◊£",
            type: "iframe",
            url: "https://www.youtube.com/embed/STE1RTNRCZA"
        },
        {
            id: Date.now() + 5,
            name: "◊û◊ï◊ñ◊ô◊ê◊ï◊ü 360",
            type: "iframe",
            url: "https://kuula.co/share/hHTCt?logo=0&info=0&fs=1&vr=1&sd=1&initload=0&thumbs=1"
        },
        {
            id: Date.now() + 6,
            name: "◊û◊©◊ó◊ß ◊ê◊ô◊ë◊®◊ô◊ù",
            type: "iframe",
            url: "https://view.genially.com/684fb8017e74465fc6cd1cc1"
        },
        {
            id: Date.now() + 7,
            name: "◊°◊®◊ò◊ï◊ü ◊ó◊ô◊ì◊î ◊ô◊ì◊ô◊ô◊ù",
            type: "iframe",
            url: "https://www.youtube.com/embed/sVxDzWyeSkw"
        },
        {
            id: Date.now() + 8,
            name: "◊°◊®◊ò◊ï◊ü ◊ó◊ô◊ì◊î ◊¢◊ï◊®",
            type: "iframe",
            url: "https://www.youtube.com/embed/ZjKP85gfQxE"
        },
        {
            id: Date.now() + 9,
            name: "◊°◊®◊ò◊ï◊ü ◊ó◊ô◊ì◊î ◊õ◊ú◊ô◊ï◊™",
            type: "iframe",
            url: "https://www.youtube.com/embed/yZVIc-_7KSQ"
        },
        {
            id: Date.now() + 10,
            name: "◊û◊©◊ó◊ß ◊°◊ï◊ú◊û◊ï◊™ ◊ï◊†◊ó◊©◊ô◊ù",
            type: "iframe",
            url: "liron.html"
        }
    ];

    // Create session in Firebase
    database.ref(`sessions/${sessionId}`).set({
        createdAt: Date.now(),
        startTime: startTime,
        status: 'waiting',
        currentActivity: {
            type: 'countdown',
            endTime: startTime
        },
        chatEnabled: true,
        timeline: defaultTimeline, // ‚úÖ ◊î◊ï◊°◊£ ◊ê◊™ ◊î◊§◊¢◊ô◊ú◊ï◊ô◊ï◊™ ◊î◊ì◊ô◊§◊ï◊ú◊ò◊ô◊ë◊ô◊ï◊™
        participants: {},
        chat: {},
        webrtc: {}
    }).then(() => {
        alert(`◊°◊©◊ü ◊†◊ï◊¶◊® ◊ë◊î◊¶◊ú◊ó◊î!\n◊ß◊ô◊©◊ï◊® ◊ú◊û◊©◊™◊™◊§◊ô◊ù: ${window.location.origin}${window.location.pathname.replace('admin.html', 'index.html')}?session=${sessionId}`);
        
        // ‚úÖ ◊¢◊ì◊õ◊ü ◊ê◊™ ◊îtimeline ◊î◊û◊ß◊ï◊û◊ô
        timeline = defaultTimeline;
        currentActivityIndex = -1;
        
        initializeSession();
        loadTimeline(); // ‚úÖ ◊ò◊¢◊ü ◊ê◊™ ◊î◊§◊¢◊ô◊ú◊ï◊ô◊ï◊™ ◊ú◊™◊¶◊ï◊í◊î
    }).catch((error) => {
        console.error('◊©◊í◊ô◊ê◊î ◊ë◊ô◊¶◊ô◊®◊™ ◊°◊©◊ü:', error);
        alert('◊©◊í◊ô◊ê◊î ◊ë◊ô◊¶◊ô◊®◊™ ◊î◊°◊©◊ü');
    });
}

        // Load existing session
        function loadSession() {
            const sessionIdInput = document.getElementById('sessionIdInput');
            const sessionId = sessionIdInput.value.trim();
            
            if (!sessionId) {
                alert('◊†◊ê ◊ú◊î◊õ◊†◊ô◊° ◊û◊ñ◊î◊î ◊°◊©◊ü');
                return;
            }

            // Check if session exists
            database.ref(`sessions/${sessionId}`).once('value', (snapshot) => {
                if (snapshot.exists()) {
                    currentSessionId = sessionId;
                    const sessionData = snapshot.val();
                    timeline = sessionData.timeline || [];
                    currentActivityIndex = sessionData.currentActivityIndex || -1;
                    initializeSession();
                    loadTimeline();
                } else {
                    alert('◊î◊°◊©◊ü ◊ú◊ê ◊ß◊ô◊ô◊ù');
                }
            });
        }

        // Initialize session UI
        function initializeSession() {
            document.getElementById('sessionStatus').textContent = `◊û◊ó◊ï◊ë◊® ◊ú◊°◊©◊ü: ${currentSessionId}`;
            document.getElementById('statusIndicator').className = 'status-indicator status-ready';
            
            // Show control panels
            document.getElementById('liveControls').style.display = 'block';
            document.getElementById('navigationControls').style.display = 'block';
            document.getElementById('participantsPanel').style.display = 'block';
            
            // Listen to participants
            listenToParticipants();
            
            // Listen to WebRTC answers
            listenToWebRTCAnswers();
            
            // Update session link
            updateSessionLink();
            // Show copy link button
            document.getElementById('copyLinkBtn').style.display = 'block';
            // Initialize camera when session starts
            initializeCamera();
        }

        // Listen to WebRTC answers and ICE candidates
// Listen to WebRTC answers and ICE candidates
function listenToWebRTCAnswers() {
    console.log('üéß ◊û◊™◊ó◊ô◊ú ◊ú◊î◊ê◊ñ◊ô◊ü ◊ú◊™◊©◊ï◊ë◊ï◊™ WebRTC...');
    
    // ◊î◊ê◊ñ◊ü ◊ú◊™◊©◊ï◊ë◊ï◊™ ◊ú◊§◊ô ◊û◊©◊™◊™◊£ - ◊™◊ô◊ß◊ï◊ü ◊î◊†◊™◊ô◊ë
    database.ref(`sessions/${currentSessionId}/webrtc/answers`).on('child_added', async (snapshot) => {
        const participantId = snapshot.key;
        const data = snapshot.val();
        
        if (data && data.answer) {
            console.log(`üì® ◊î◊™◊ß◊ë◊ú◊î ◊™◊©◊ï◊ë◊î ◊û-${participantId}`);
            
            const pc = peerConnections.get(participantId);
            if (pc && pc.signalingState === 'have-local-offer') {
                try {
                    await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
                    console.log(`‚úÖ Remote description ◊†◊ß◊ë◊¢ ◊¢◊ë◊ï◊® ${participantId}`);
                    connectedStudents.add(participantId);
                    updateStreamStatus(`◊û◊ó◊ï◊ë◊® ◊ú-${connectedStudents.size} ◊û◊©◊™◊™◊§◊ô◊ù`);
                } catch (error) {
                    console.error(`‚ùå ◊©◊í◊ô◊ê◊î ◊ë◊ß◊ë◊ô◊¢◊™ remote description ◊¢◊ë◊ï◊® ${participantId}:`, error);
                }
            } else {
                console.warn(`‚ö†Ô∏è PeerConnection ◊¢◊ë◊ï◊® ${participantId} ◊ú◊ê ◊ë◊û◊¶◊ë ◊û◊™◊ê◊ô◊ù: ${pc?.signalingState}`);
            }
        }
    });

    // ◊î◊ê◊ñ◊ü ◊ú-ICE candidates - ◊™◊ô◊ß◊ï◊ü ◊î◊ò◊ô◊§◊ï◊ú
    database.ref(`sessions/${currentSessionId}/webrtc/student-candidates`).on('child_added', async (snapshot) => {
        const candidateData = snapshot.val();
        
        // ◊ï◊ï◊ì◊ê ◊©◊ô◊© participantId ◊ï-candidate ◊™◊ß◊ô◊ü
        if (candidateData && candidateData.participantId && candidateData.candidate) {
            const pc = peerConnections.get(candidateData.participantId);
            
            // ◊ë◊ì◊ï◊ß ◊©◊ô◊© peer connection ◊ïremote description
            if (pc && pc.remoteDescription) {
                try {
                    // ◊ï◊ì◊ê ◊©◊î-candidate ◊™◊ß◊ô◊ü ◊ú◊§◊†◊ô ◊î◊ï◊°◊§◊î
                    const candidate = candidateData.candidate;
                    if (candidate.candidate && (candidate.sdpMid !== null || candidate.sdpMLineIndex !== null)) {
                        await pc.addIceCandidate(new RTCIceCandidate(candidate));
                        console.log(`‚úÖ ICE candidate ◊†◊ï◊°◊£ ◊¢◊ë◊ï◊® ${candidateData.participantId}`);
                    } else {
                        console.warn(`‚ö†Ô∏è ICE candidate ◊ú◊ê ◊™◊ß◊ô◊ü ◊¢◊ë◊ï◊® ${candidateData.participantId}:`, candidate);
                    }
                } catch (error) {
                    console.error(`‚ùå ◊©◊í◊ô◊ê◊î ◊ë◊î◊ï◊°◊§◊™ ICE candidate ◊¢◊ë◊ï◊® ${candidateData.participantId}:`, error);
                }
            } else {
                console.warn(`‚ö†Ô∏è PeerConnection ◊ú◊ê ◊û◊ï◊õ◊ü ◊¢◊ë◊ï◊® ${candidateData.participantId}, ◊û◊ó◊õ◊î...`);
            }
        }
    });
}

        // Listen to participants updates
        function listenToParticipants() {
            database.ref(`sessions/${currentSessionId}/participants`).on('value', (snapshot) => {
                const participants = snapshot.val() || {};
                updateParticipantsList(participants);
                
                // Create peer connections for new participants if streaming
                if (isStreaming) {
                    Object.keys(participants).forEach(participantId => {
                        if (!peerConnections.has(participantId)) {
                            createPeerConnectionForParticipant(participantId);
                        }
                    });
                }
            });
        }

        // Create peer connection for specific participant
// Create peer connection for specific participant
// Create peer connection for specific participant
// Create peer connection for specific participant
async function createPeerConnectionForParticipant(participantId) {
    try {
        console.log(`üîó ◊ô◊ï◊¶◊® ◊ó◊ô◊ë◊ï◊® WebRTC ◊¢◊ë◊ï◊® ${participantId}`);
        
        const pc = new RTCPeerConnection(rtcConfig);
        peerConnections.set(participantId, pc);
        
        // Handle ICE candidates
        pc.onicecandidate = (event) => {
            if (event.candidate) {
                console.log(`üì§ ◊©◊ï◊ú◊ó ICE candidate ◊¢◊ë◊ï◊® ${participantId}`);
                
                const candidate = event.candidate;
                if (candidate.candidate && (candidate.sdpMid !== null || candidate.sdpMLineIndex !== null)) {
                    database.ref(`sessions/${currentSessionId}/webrtc/admin-candidates/${participantId}`).push({
                        candidate: candidate.candidate,
                        sdpMid: candidate.sdpMid,
                        sdpMLineIndex: candidate.sdpMLineIndex,
                        timestamp: Date.now()
                    });
                } else {
                    console.warn(`‚ö†Ô∏è ICE candidate ◊ú◊ê ◊™◊ß◊ô◊ü ◊¢◊ë◊ï◊® ${participantId}, ◊û◊ì◊ú◊í...`);
                }
            }
        };

        // Handle connection state
        pc.onconnectionstatechange = () => {
            console.log(`üîó ◊û◊¶◊ë ◊ó◊ô◊ë◊ï◊® ◊¢◊ë◊ï◊® ${participantId}:`, pc.connectionState);
            if (pc.connectionState === 'connected') {
                connectedStudents.add(participantId);
                updateStreamStatus(`◊û◊ó◊ï◊ë◊® ◊ú-${connectedStudents.size} ◊û◊©◊™◊™◊§◊ô◊ù`);
            } else if (pc.connectionState === 'disconnected' || pc.connectionState === 'failed') {
                connectedStudents.delete(participantId);
                updateStreamStatus(`◊û◊ó◊ï◊ë◊® ◊ú-${connectedStudents.size} ◊û◊©◊™◊™◊§◊ô◊ù`);
            }
        };
// ◊™◊ï◊°◊ô◊£ ◊ê◊™ ◊ñ◊î ◊ë◊§◊ï◊†◊ß◊¶◊ô◊î createPeerConnectionForParticipant
// ◊ê◊ó◊®◊ô ◊î-connectionstatechange handler:

pc.onconnectionstatechange = async () => {
    console.log(`üîó ◊û◊¶◊ë ◊ó◊ô◊ë◊ï◊® ◊¢◊ë◊ï◊® ${participantId}:`, pc.connectionState);
    if (pc.connectionState === 'connected') {
        connectedStudents.add(participantId);
        updateStreamStatus(`◊û◊ó◊ï◊ë◊® ◊ú-${connectedStudents.size} ◊û◊©◊™◊™◊§◊ô◊ù`);
        
        // ‚ú® DEBUG ◊ó◊ì◊©: ◊ë◊ì◊ô◊ß◊î ◊û◊î ◊ë◊ê◊û◊™ ◊†◊©◊ú◊ó
        const senders = pc.getSenders();
        for (const sender of senders) {
            if (sender.track && sender.track.kind === 'video') {
                const stats = await pc.getStats(sender);
                stats.forEach(report => {
                    if (report.type === 'outbound-rtp' && report.mediaType === 'video') {
                        console.log(`üìä Stats ◊¢◊ë◊ï◊® ${participantId}:`, {
                            width: report.frameWidth,
                            height: report.frameHeight,
                            bitrate: report.bytesSent,
                            fps: report.framesPerSecond,
                            codec: report.codecId
                        });
                    }
                });
                
                // ◊í◊ù ◊ë◊ì◊ï◊ß ◊ê◊™ ◊î◊î◊í◊ì◊®◊ï◊™ ◊©◊ú ◊î-track ◊¢◊¶◊û◊ï
                const trackSettings = sender.track.getSettings();
                console.log(`üìπ Track settings ◊¢◊ë◊ï◊® ${participantId}:`, trackSettings);
                
                // ◊ë◊ì◊ï◊ß constraints
                const trackConstraints = sender.track.getConstraints();
                console.log(`üìã Track constraints ◊¢◊ë◊ï◊® ${participantId}:`, trackConstraints);
            }
        }
    }
};
        // Add local stream tracks ◊¢◊ù ◊ê◊ô◊ú◊ï◊• ◊®◊ñ◊ï◊ú◊ï◊¶◊ô◊î
        if (localStream && localStream.active) {
            console.log('üìπ ◊û◊ï◊°◊ô◊£ tracks ◊úconnection:', localStream.getTracks().length);
            
            for (const track of localStream.getTracks()) {
                console.log(`üìπ Track: ${track.kind}, enabled: ${track.enabled}, readyState: ${track.readyState}`);
                
                const sender = pc.addTrack(track, localStream);
                
                // ◊™◊ô◊ß◊ï◊ü ◊ó◊©◊ï◊ë: ◊ê◊ô◊ú◊ï◊• ◊®◊ñ◊ï◊ú◊ï◊¶◊ô◊î ◊í◊ë◊ï◊î◊î ◊ú◊ï◊ô◊ì◊ô◊ê◊ï
                if (track.kind === 'video') {
                    // ◊û◊ó◊õ◊î ◊ú◊ó◊ô◊ë◊ï◊® ◊ï◊ê◊ñ ◊û◊í◊ì◊ô◊® ◊§◊®◊û◊ò◊®◊ô◊ù
                    pc.addEventListener('connectionstatechange', async () => {
                        if (pc.connectionState === 'connected') {
                            try {
                                const params = sender.getParameters();
                                console.log('üìã Current encoding params:', params);
                                
                                if (params.encodings && params.encodings.length > 0) {
                                    // ◊î◊í◊ì◊®◊ï◊™ ◊ê◊ô◊õ◊ï◊™ ◊û◊ß◊°◊ô◊û◊ú◊ô◊™
                                    params.encodings[0].maxBitrate = 5000000; // 5 Mbps
                                    params.encodings[0].maxFramerate = 30;
                                    params.encodings[0].scaleResolutionDownBy = 1; // ◊ú◊ú◊ê ◊î◊ß◊ò◊†◊î!
                                    
                                    // ◊†◊°◊î ◊í◊ù ◊ú◊î◊í◊ì◊ô◊® ◊®◊ñ◊ï◊ú◊ï◊¶◊ô◊î ◊°◊§◊¶◊ô◊§◊ô◊™
                                    if (params.encodings[0].rid === undefined) {
                                        params.encodings[0].maxWidth = 1280;
                                        params.encodings[0].maxHeight = 720;
                                    }
                                    
                                    await sender.setParameters(params);
                                    console.log('‚úÖ Video encoding parameters updated:', params.encodings[0]);
                                } else {
                                    console.warn('‚ö†Ô∏è ◊ê◊ô◊ü encodings ◊ñ◊û◊ô◊†◊ô◊ù');
                                }
                            } catch (error) {
                                console.error('‚ùå ◊©◊í◊ô◊ê◊î ◊ë◊î◊í◊ì◊®◊™ ◊§◊®◊û◊ò◊®◊ô◊ù:', error);
                            }
                        }
                    });
                    
                    // ◊í◊ù ◊û◊ô◊ì ◊†◊°◊î ◊ú◊î◊í◊ì◊ô◊®
                    try {
                        const initialParams = sender.getParameters();
                        if (initialParams.encodings && initialParams.encodings.length > 0) {
                            initialParams.encodings[0].maxBitrate = 5000000;
                            initialParams.encodings[0].maxFramerate = 30;
                            initialParams.encodings[0].scaleResolutionDownBy = 1;
                            await sender.setParameters(initialParams);
                            console.log('‚úÖ Initial video parameters set');
                        }
                    } catch (error) {
                        console.warn('‚ö†Ô∏è Could not set initial parameters:', error);
                    }
                }
            }
        } else {
            console.error('‚ùå Local stream ◊ú◊ê ◊§◊¢◊ô◊ú!', localStream);
        }
        
        console.log(`‚úÖ Peer connection ◊†◊ï◊¶◊® ◊¢◊ë◊ï◊® ${participantId}`);
        
    } catch (error) {
        console.error(`‚ùå ◊©◊í◊ô◊ê◊î ◊ë◊ô◊¶◊ô◊®◊™ peer connection ◊¢◊ë◊ï◊® ${participantId}:`, error);
    }
}

        // Update participants list
        function updateParticipantsList(participants) {
            const participantsList = document.getElementById('participantsList');
            const participantCount = document.getElementById('participantCount');
            
            const participantsArray = Object.entries(participants).map(([id, data]) => ({
                id,
                ...data
            })).sort((a, b) => (b.score || 0) - (a.score || 0));
            
            participantCount.textContent = `${participantsArray.length} ◊û◊©◊™◊™◊§◊ô◊ù`;
            
            participantsList.innerHTML = participantsArray.map(participant => `
                <div class="participant-item">
                    <span class="participant-name">${participant.name}</span>
                    <span class="participant-score">${participant.score || 0}</span>
                </div>
            `).join('');
        }

        // Toggle live stream
        function toggleLive() {
            if (!isStreaming) {
                startStreaming();
            } else {
                stopStreaming();
            }
        }

        async function startStreaming() {
            try {
                console.log('üé¨ ◊û◊™◊ó◊ô◊ú ◊©◊ô◊ì◊ï◊® ◊ó◊ô...');
                
                if (!localStream) {
                    await initializeCamera();
                }
                
                if (!localStream) {
                    throw new Error('◊ú◊ê ◊†◊ô◊™◊ü ◊ú◊ê◊™◊ó◊ú ◊û◊¶◊ú◊û◊î');
                }
                
                isStreaming = true;
                document.getElementById('liveBtn').textContent = '‚èπÔ∏è ◊¢◊¶◊ï◊® ◊©◊ô◊ì◊ï◊®';
                document.getElementById('statusIndicator').className = 'status-indicator status-live';
                updateStreamStatus('◊û◊™◊ó◊ô◊ú ◊©◊ô◊ì◊ï◊®...');
                
                // Clear any existing WebRTC data
                await database.ref(`sessions/${currentSessionId}/webrtc`).remove();
                
                // Create peer connections for existing participants
                const participantsSnapshot = await database.ref(`sessions/${currentSessionId}/participants`).once('value');
                const participants = participantsSnapshot.val() || {};
                
                for (const participantId of Object.keys(participants)) {
                    await createPeerConnectionForParticipant(participantId);
                }
                
                // Create and send offer
                await createAndSendOffer();
                
                // Update activity
                database.ref(`sessions/${currentSessionId}/currentActivity`).set({
                    type: 'live',
                    streaming: true,
                    timestamp: Date.now()
                });
                
                console.log('‚úÖ ◊©◊ô◊ì◊ï◊® ◊ó◊ô ◊î◊™◊ó◊ô◊ú ◊ë◊î◊¶◊ú◊ó◊î');
                        document.getElementById('returnToLiveBtn').style.display = 'none';

            } catch (error) {
                console.error('‚ùå ◊©◊í◊ô◊ê◊î ◊ë◊î◊™◊ó◊ú◊™ ◊©◊ô◊ì◊ï◊®:', error);
                alert('◊©◊í◊ô◊ê◊î ◊ë◊î◊™◊ó◊ú◊™ ◊î◊©◊ô◊ì◊ï◊®: ' + error.message);
                stopStreaming();
            }
        }
async function createAndSendOffer() {
    try {
        const participants = await database.ref(`sessions/${currentSessionId}/participants`).once('value');
        const participantIds = Object.keys(participants.val() || {});
        
        for (const participantId of participantIds) {
            const pc = peerConnections.get(participantId);
            if (pc) {
                // ◊ô◊¶◊ô◊®◊™ offer ◊¢◊ù ◊ê◊ô◊ú◊ï◊• ◊ê◊ô◊õ◊ï◊™ ◊í◊ë◊ï◊î◊î
                const offer = await pc.createOffer({
                    offerToReceiveAudio: false,
                    offerToReceiveVideo: false
                });
                
                // ◊ê◊ô◊ú◊ï◊• ◊®◊ñ◊ï◊ú◊ï◊¶◊ô◊î ◊ë-SDP
                let modifiedSdp = offer.sdp;
                
                // ◊î◊ï◊°◊£ bandwidth ◊í◊ë◊ï◊î
                if (modifiedSdp.includes('m=video')) {
                    modifiedSdp = modifiedSdp.replace(
                        /(m=video \d+ [^\r\n]+)/,
                        '$1\r\nb=AS:5000'
                    );
                }
                
                // ◊î◊ï◊°◊£ ◊§◊®◊û◊ò◊®◊ô ◊ê◊ô◊õ◊ï◊™ ◊ú◊ï◊ô◊ì◊ô◊ê◊ï
                modifiedSdp = modifiedSdp.replace(
                    /(a=rtpmap:\d+ H264[^\r\n]+)/g,
                    '$1\r\na=fmtp:96 profile-level-id=42e01f;level-asymmetry-allowed=1;packetization-mode=1'
                );
                
                const modifiedOffer = {
                    type: offer.type,
                    sdp: modifiedSdp
                };
                
                await pc.setLocalDescription(modifiedOffer);
                
                await database.ref(`sessions/${currentSessionId}/webrtc/offers/${participantId}`).set({
                    offer: modifiedOffer,
                    timestamp: Date.now()
                });
                
                console.log(`üì§ High-quality offer ◊†◊©◊ú◊ó ◊ú-${participantId}`);
            }
        }
        
        console.log('üì§ WebRTC offers ◊†◊©◊ú◊ó◊ï ◊ú◊õ◊ú ◊î◊û◊©◊™◊™◊§◊ô◊ù');
        
    } catch (error) {
        console.error('‚ùå ◊©◊í◊ô◊ê◊î ◊ë◊ô◊¶◊ô◊®◊™ offers:', error);
        throw error;
    }
}

        function stopStreaming() {
            try {
                console.log('‚èπÔ∏è ◊¢◊ï◊¶◊® ◊©◊ô◊ì◊ï◊® ◊ó◊ô...');
                
                isStreaming = false;
                document.getElementById('liveBtn').textContent = 'üî¥ ◊î◊™◊ó◊ú ◊©◊ô◊ì◊ï◊® ◊ó◊ô';
                document.getElementById('statusIndicator').className = 'status-indicator status-ready';
                updateStreamStatus('◊©◊ô◊ì◊ï◊® ◊î◊ï◊§◊°◊ß');
                
                // Close all peer connections
                peerConnections.forEach((pc, participantId) => {
                    console.log(`üîå ◊°◊ï◊í◊® ◊ó◊ô◊ë◊ï◊® ◊¢◊ë◊ï◊® ${participantId}`);
                    pc.close();
                });
                peerConnections.clear();
                connectedStudents.clear();
                
                // Clear WebRTC data
                database.ref(`sessions/${currentSessionId}/webrtc`).remove();
                
                // Update activity
                database.ref(`sessions/${currentSessionId}/currentActivity`).set({
                    type: 'live',
                    streaming: false,
                    timestamp: Date.now()
                });
                
                console.log('‚úÖ ◊©◊ô◊ì◊ï◊® ◊î◊ï◊§◊°◊ß ◊ë◊î◊¶◊ú◊ó◊î');
                        document.getElementById('returnToLiveBtn').style.display = 'none';

            } catch (error) {
                console.error('‚ùå ◊©◊í◊ô◊ê◊î ◊ë◊î◊§◊°◊ß◊™ ◊©◊ô◊ì◊ï◊®:', error);
            }
        }

        // Toggle chat
        function toggleChat() {
            const chatBtn = document.getElementById('chatBtn');
            
            isChatEnabled = !isChatEnabled;
            
            if (isChatEnabled) {
                chatBtn.textContent = 'üí¨ ◊õ◊ë◊î ◊¶\'◊ê◊ò';
                chatBtn.className = 'btn btn-warning';
            } else {
                chatBtn.textContent = 'üí¨ ◊î◊§◊¢◊ú ◊¶\'◊ê◊ò';
                chatBtn.className = 'btn btn-success';
            }
            
            // Update Firebase
            database.ref(`sessions/${currentSessionId}/chatEnabled`).set(isChatEnabled);
        }

        // Show countdown
        function showCountdown() {
            const minutes = prompt('◊õ◊û◊î ◊ì◊ß◊ï◊™ ◊¢◊ì ◊î◊™◊ó◊ú◊™ ◊î◊§◊¢◊ô◊ú◊ï◊™?', '2');
            if (!minutes) return;
            
            const endTime = Date.now() + (parseInt(minutes) * 60 * 1000);
            
            database.ref(`sessions/${currentSessionId}/currentActivity`).set({
                type: 'countdown',
                endTime: endTime,
                timestamp: Date.now()
            });
            
            updateCurrentActivityDisplay('◊©◊¢◊ï◊ü ◊î◊°◊§◊ô◊®◊î ◊ú◊ê◊ó◊ï◊®');
        }

        // Navigation functions
        function previousActivity() {
            if (currentActivityIndex > 0) {
                currentActivityIndex--;
                executeActivity(timeline[currentActivityIndex]);
                updateTimeline();
            }
        }

        function nextActivity() {
            if (currentActivityIndex < timeline.length - 1) {
                currentActivityIndex++;
                executeActivity(timeline[currentActivityIndex]);
                updateTimeline();
            }
        }

// Execute activity
function executeActivity(activity) {
    if (!activity) return;
    
    database.ref(`sessions/${currentSessionId}/currentActivity`).set({
        ...activity,
        timestamp: Date.now()
    });
    
    database.ref(`sessions/${currentSessionId}/currentActivityIndex`).set(currentActivityIndex);
    
    updateCurrentActivityDisplay(activity.name);
    
    // ‚úÖ ◊î◊¶◊í/◊î◊°◊™◊® ◊õ◊§◊™◊ï◊® ◊ó◊ñ◊®◊î ◊ú◊©◊ô◊ì◊ï◊® ◊ó◊ô
    const returnBtn = document.getElementById('returnToLiveBtn');
    if (activity.type !== 'live' && isStreaming) {
        returnBtn.style.display = 'inline-block';
    } else {
        returnBtn.style.display = 'none';
    }
}

        // Update current activity display
        function updateCurrentActivityDisplay(activityName) {
            document.getElementById('currentActivityDisplay').textContent = 
                `◊§◊¢◊ô◊ú◊ï◊™ ◊†◊ï◊õ◊ó◊ô◊™: ${activityName}`;
        }

        // Show add activity modal
        function showAddActivityModal() {
            document.getElementById('addActivityModal').style.display = 'block';
        }

        // Close add activity modal
        function closeAddActivityModal() {
            document.getElementById('addActivityModal').style.display = 'none';
            selectedActivityType = null;
            clearActivityForms();
        }

        // Select activity type
        function selectActivityType(type) {
            selectedActivityType = type;
            
            // Update UI
            document.querySelectorAll('.activity-type').forEach(el => {
                el.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            // Show relevant form
            clearActivityForms();
            if (type === 'iframe') {
                document.getElementById('iframeForm').style.display = 'block';
            } else if (type === 'question') {
                document.getElementById('questionForm').style.display = 'block';
            } else if (type === 'break') {
                document.getElementById('breakForm').style.display = 'block';
            }
        }

        // Clear activity forms
        function clearActivityForms() {
            document.getElementById('iframeForm').style.display = 'none';
            document.getElementById('questionForm').style.display = 'none';
            document.getElementById('breakForm').style.display = 'none';
        }

        // Add activity
        function addActivity() {
            if (!selectedActivityType) {
                alert('◊†◊ê ◊ú◊ë◊ó◊ï◊® ◊°◊ï◊í ◊§◊¢◊ô◊ú◊ï◊™');
                return;
            }
            
            const activityName = document.getElementById('activityName').value.trim();
            if (!activityName) {
                alert('◊†◊ê ◊ú◊î◊õ◊†◊ô◊° ◊©◊ù ◊ú◊§◊¢◊ô◊ú◊ï◊™');
                return;
            }
            
            const activity = {
                id: Date.now(),
                name: activityName,
                type: selectedActivityType
            };
            
            // Add type-specific data
            if (selectedActivityType === 'iframe') {
                const url = document.getElementById('activityUrl').value.trim();
                if (!url) {
                    alert('◊†◊ê ◊ú◊î◊õ◊†◊ô◊° ◊ß◊ô◊©◊ï◊®');
                    return;
                }
                activity.url = url;
            } else if (selectedActivityType === 'question') {
                const questionText = document.getElementById('questionText').value.trim();
                const answers = document.getElementById('questionAnswers').value.trim();
                const correctAnswer = parseInt(document.getElementById('correctAnswer').value);
                const timeLimit = parseInt(document.getElementById('questionTime').value);
                
                if (!questionText || !answers) {
                    alert('◊†◊ê ◊ú◊û◊ú◊ê ◊ê◊™ ◊õ◊ú ◊î◊©◊ì◊ï◊™');
                    return;
                }
                
                activity.question = questionText;
                activity.answers = answers.split(',').map(a => a.trim());
                activity.correctAnswer = correctAnswer - 1; // Zero-based index
                activity.timeLimit = timeLimit;
            } else if (selectedActivityType === 'break') {
                const breakTime = parseInt(document.getElementById('breakTime').value);
                activity.duration = breakTime * 60 * 1000; // Convert to milliseconds
            }
            
            // Add to timeline
            timeline.push(activity);
            updateTimelineInFirebase();
            loadTimeline();
            closeAddActivityModal();
        }

        // Update timeline in Firebase
        function updateTimelineInFirebase() {
            database.ref(`sessions/${currentSessionId}/timeline`).set(timeline);
        }

        // Load timeline
        function loadTimeline() {
            const timelineItems = document.getElementById('timelineItems');
            
            timelineItems.innerHTML = timeline.map((activity, index) => {
                let statusClass = '';
                if (index < currentActivityIndex) statusClass = 'completed';
                else if (index === currentActivityIndex) statusClass = 'current';
                
                let typeIcon = '';
                switch (activity.type) {
                    case 'live': typeIcon = 'üé•'; break;
                    case 'iframe': typeIcon = 'üéÆ'; break;
                    case 'question': typeIcon = '‚ùì'; break;
                    case 'break': typeIcon = '‚òï'; break;
                }
                
                return `
                    <div class="timeline-item ${statusClass}" onclick="jumpToActivity(${index})">
                        <div class="item-title">${typeIcon} ${activity.name}</div>
                        <div class="item-type">${getActivityTypeName(activity.type)}</div>
                    </div>
                `;
            }).join('');
        }

        // Get activity type name
        function getActivityTypeName(type) {
            switch (type) {
                case 'live': return '◊©◊ô◊ì◊ï◊® ◊ó◊ô';
                case 'iframe': return '◊§◊¢◊ô◊ú◊ï◊™/◊û◊©◊ó◊ß';
                case 'question': return '◊©◊ê◊ú◊î ◊ê◊û◊®◊ô◊ß◊ê◊ô◊™';
                case 'break': return '◊î◊§◊°◊ß◊î';
                default: return type;
            }
        }

        // Jump to activity
        function jumpToActivity(index) {
            currentActivityIndex = index;
            executeActivity(timeline[index]);
            updateTimeline();
        }

        // Update timeline UI
        function updateTimeline() {
            loadTimeline();
        }

        // Show leaderboard
        function showLeaderboard() {
            database.ref(`sessions/${currentSessionId}/participants`).once('value', (snapshot) => {
                const participants = snapshot.val() || {};
                const sorted = Object.entries(participants)
                    .map(([id, data]) => ({ id, ...data }))
                    .sort((a, b) => (b.score || 0) - (a.score || 0))
                    .slice(0, 3);
                
                const leaderboardData = {
                    timestamp: Date.now(),
                    top3: sorted
                };
                
                database.ref(`sessions/${currentSessionId}/currentActivity`).set({
                    type: 'leaderboard',
                    data: leaderboardData,
                    timestamp: Date.now()
                });
                
                updateCurrentActivityDisplay('◊ú◊ï◊ó ◊™◊ï◊¶◊ê◊ï◊™');
            });
        }

        // Update session link
        function updateSessionLink() {
            const link = `${window.location.origin}${window.location.pathname.replace('admin.html', 'index.html')}?session=${currentSessionId}`;
            console.log('◊ß◊ô◊©◊ï◊® ◊ú◊°◊©◊ü:', link);
        }
        // Reset camera
// Reset camera - ◊™◊ô◊ß◊ï◊ü ◊û◊ú◊ê
async function resetCamera() {
    console.log('üîÑ ◊û◊ê◊§◊° ◊û◊¶◊ú◊û◊î...');
    
    // ◊¢◊¶◊ï◊® ◊©◊ô◊ì◊ï◊® ◊ê◊ù ◊§◊ï◊¢◊ú
    const wasStreaming = isStreaming;
    if (isStreaming) {
        stopStreaming();
    }
    
    // ◊¢◊¶◊ï◊® ◊ê◊™ ◊î◊ñ◊®◊ù ◊î◊†◊ï◊õ◊ó◊ô
    if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
        localStream = null;
    }
    
    // ◊ó◊õ◊î ◊ß◊¶◊™
    await new Promise(resolve => setTimeout(resolve, 1000));
    
    // ◊î◊§◊¢◊ú ◊û◊ó◊ì◊©
    await initializeCamera();
    
    // ◊ê◊ù ◊î◊ô◊î ◊©◊ô◊ì◊ï◊®, ◊î◊™◊ó◊ú ◊©◊ï◊ë
    if (wasStreaming) {
        setTimeout(() => {
            startStreaming();
        }, 2000);
    }
}

        // Copy session link to clipboard
        function copySessionLink() {
            const link = `${window.location.origin}${window.location.pathname.replace('admin.html', 'index.html')}?session=${currentSessionId}`;
            
            navigator.clipboard.writeText(link).then(() => {
                alert('◊î◊ß◊ô◊©◊ï◊® ◊î◊ï◊¢◊™◊ß ◊ú◊ú◊ï◊ó! üìã\n\n' + link);
            }).catch(() => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = link;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('◊î◊ß◊ô◊©◊ï◊® ◊î◊ï◊¢◊™◊ß ◊ú◊ú◊ï◊ó! üìã\n\n' + link);
            });
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            // Set default session ID
            const now = new Date();
            const defaultSessionId = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}-${now.getHours()}${String(now.getMinutes()).padStart(2, '0')}`;
            document.getElementById('sessionIdInput').value = defaultSessionId;
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            // Close all peer connections
            peerConnections.forEach(pc => pc.close());
            
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
        });
// ‚úÖ ◊§◊ï◊†◊ß◊¶◊ô◊î ◊ó◊ì◊©◊î - ◊ó◊ñ◊®◊î ◊ú◊©◊ô◊ì◊ï◊® ◊ó◊ô
function returnToLive() {
    // ◊¢◊ì◊õ◊ü ◊ú◊§◊¢◊ô◊ú◊ï◊™ ◊©◊ô◊ì◊ï◊® ◊ó◊ô
    database.ref(`sessions/${currentSessionId}/currentActivity`).set({
        type: 'live',
        streaming: isStreaming,
        timestamp: Date.now()
    });
    
    // ◊¢◊ì◊õ◊ü ◊ê◊™ ◊î◊™◊¶◊ï◊í◊î ◊î◊û◊ß◊ï◊û◊ô◊™
    updateCurrentActivityDisplay('◊©◊ô◊ì◊ï◊® ◊ó◊ô');
    
    // ◊î◊°◊™◊® ◊ê◊™ ◊î◊õ◊§◊™◊ï◊®
    document.getElementById('returnToLiveBtn').style.display = 'none';
    
    console.log('üîÑ ◊ó◊ñ◊®◊î ◊ú◊©◊ô◊ì◊ï◊® ◊ó◊ô');
}
    </script>
</body>
</html>
